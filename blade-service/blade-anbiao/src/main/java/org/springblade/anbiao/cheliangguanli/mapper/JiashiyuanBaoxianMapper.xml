<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.springblade.anbiao.cheliangguanli.mapper.JiashiyuanBaoxianMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="jiashiyuanBaoxianResultMap" type="org.springblade.anbiao.cheliangguanli.entity.JiashiyuanBaoxian">
        <id column="ajb_ids" property="ajbIds"/>
        <result column="ajb_policy_no" property="ajbPolicyNo"/>
        <result column="ajb_dept_ids" property="ajbDeptIds"/>
        <result column="ajb_insured_ids" property="ajbInsuredIds"/>
        <result column="ajb_certificate_number" property="ajbCertificateNumber"/>
        <result column="ajb_insured_name" property="ajbInsuredName"/>
        <result column="ajb_insured_contacts" property="ajbInsuredContacts"/>
        <result column="ajb_insured_contact_number" property="ajbInsuredContactNumber"/>
        <result column="ajb_insured_contact_address" property="ajbInsuredContactAddress"/>
        <result column="ajb_insure_ids" property="ajbInsureIds"/>
        <result column="ajb_insure_name" property="ajbInsureName"/>
        <result column="ajb_insure_contacts" property="ajbInsureContacts"/>
        <result column="ajb_insure_contact_number" property="ajbInsureContactNumber"/>
        <result column="ajb_insure_contact_address" property="ajbInsureContactAddress"/>
        <result column="ajb_insurance_period_start" property="ajbInsurancePeriodStart"/>
        <result column="ajb_insurance_period_end" property="ajbInsurancePeriodEnd"/>
        <result column="ajb_insurance_days" property="ajbInsuranceDays"/>
        <result column="ajb_calculation_method" property="ajbCalculationMethod"/>
        <result column="ajb_aj_ids" property="ajbAjIds"/>
        <result column="ajb_year_security_pooling_fund" property="ajbYearSecurityPoolingFund"/>
        <result column="ajb_year_premium" property="ajbYearPremium"/>
        <result column="ajb_insurance_company" property="ajbInsuranceCompany"/>
        <result column="ajb_baoshi_bao_no" property="ajbBaoshiBaoNo"/>
        <result column="ajb_signing_date" property="ajbSigningDate"/>
        <result column="ajb_total" property="ajbTotal"/>
        <result column="ajb_replacement_price" property="ajbReplacementPrice"/>
        <result column="ajb_bail_company_date" property="ajbBailCompanyDate"/>
        <result column="ajb_bail_headquarters_date" property="ajbBailHeadquartersDate"/>
        <result column="ajb_compensation_standard" property="ajbCompensationStandard"/>
        <result column="ajb_are_accidents" property="ajbAreAccidents"/>
        <result column="ajb_purchase_method" property="ajbPurchaseMethod"/>
        <result column="ajb_insurance_ratio" property="ajbInsuranceRatio"/>
        <result column="ajb_permitted_seat" property="ajbPermittedSeat"/>
        <result column="ajb_permitted_seat_driver_seat" property="ajbPermittedSeatDriverSeat"/>
        <result column="ajb_permitted_seat_front_seats" property="ajbPermittedSeatFrontSeats"/>
        <result column="ajb_permitted_seat_back_row_seats" property="ajbPermittedSeatBackRowSeats"/>
        <result column="ajb_live_seat" property="ajbLiveSeat"/>
        <result column="ajb_live_seat_driver_seat" property="ajbLiveSeatDriverSeat"/>
        <result column="ajb_live_seat_front_seats" property="ajbLiveSeatFrontSeats"/>
        <result column="ajb_live_seat_back_row_seats" property="ajbLiveSeatBackRowSeats"/>
        <result column="ajb_seating_mode" property="ajbSeatingMode"/>
        <result column="ajb_driver_seat_rate" property="ajbDriverSeatRate"/>
        <result column="ajb_front_row_rate" property="ajbFrontRowRate"/>
        <result column="ajb_back_row_rate" property="ajbBackRowRate"/>
        <result column="ajb_vehicle_and_vessel_tax" property="ajbVehicleAndVesselTax"/>
        <result column="ajb_vehicle_and_vessel_tax_reduction" property="ajbVehicleAndVesselTaxReduction"/>
        <result column="ajb_vehicle_and_vessel_tax_paid_in" property="ajbVehicleAndVesselTaxPaidIn"/>
        <result column="ajb_total_premium" property="ajbTotalPremium"/>
        <result column="ajb_company_total_premium" property="ajbCompanyTotalPremium"/>
        <result column="ajb_total_planned_premium" property="ajbTotalPlannedPremium"/>
        <result column="ajb_totalize_premium" property="ajbTotalizePremium"/>
        <result column="ajb_company_totalize_premium" property="ajbCompanyTotalizePremium"/>
        <result column="ajb_approve" property="ajbApprove"/>
        <result column="ajb_special_agreement" property="ajbSpecialAgreement"/>
        <result column="ajb_enclosure" property="ajbEnclosure"/>
        <result column="ajb_delete" property="ajbDelete"/>
        <result column="ajb_create_time" property="ajbCreateTime"/>
        <result column="ajb_create_by_ids" property="ajbCreateByIds"/>
        <result column="ajb_create_by_name" property="ajbCreateByName"/>
        <result column="ajb_update_time" property="ajbUpdateTime"/>
        <result column="ajb_update_by_ids" property="ajbUpdateByIds"/>
        <result column="ajb_update_by_name" property="ajbUpdateByName"/>
        <result column="dept_name" property="ajbDeptName"/>
        <result column="ajb_insure_deptid" property="ajbInsureDeptid"/>
    </resultMap>


    <select id="selectJiashiyuanBaoxianPage" resultMap="jiashiyuanBaoxianResultMap">
        select
            DISTINCT ajb.*,bd.dept_name,IFNULL(cc.ajbm_company_amount,0) as ajbmInsuranceAmount,IFNULL(ajbm_basic_premium,0) as ajbmBasicPremium
        from
            anbiao_jiashiyuan_baoxian ajb
        inner join  (
            SELECT
                DISTINCT
                xiaji.id,
                xiaji.parent_id,
                xiaji.dept_name,
                xiaji.is_deleted
            FROM
                blade_dept shangji,
                blade_dept xiaji
            WHERE xiaji.tree_code LIKE CONCAT(shangji.tree_code,'%')
                AND xiaji.is_deleted = 0 AND xiaji.extend_type='机构'
            <if test="jiashiyuanBaoxian.deptId != null and jiashiyuanBaoxian.deptId != ''">
                AND shangji.id= #{jiashiyuanBaoxian.deptId}
            </if>
        ) bd on ajb.ajb_dept_ids = bd.id
        left join (
            select
                ajbm_avb_ids,IFNULL(SUM(ajbm_company_amount),0) as ajbm_company_amount,IFNULL(SUM(ajbm_basic_premium),0) as ajbm_basic_premium
            from
                anbiao_jiashiyuan_baoxian_mingxi
            GROUP BY
                ajbm_avb_ids
        ) cc on cc.ajbm_avb_ids = ajb.ajb_ids
        <where>
                ajb.ajb_delete = 0
              <if test="ajbInsuredIds != null">
                and ajb.ajb_insured_ids= #{ajbInsuredIds}
              </if>
            <if test="jiashiyuanBaoxian.ajbInsuredName !=null and jiashiyuanBaoxian.ajbInsuredName != ''">
                and ajb.ajb_insured_name like concat('%', #{jiashiyuanBaoxian.ajbInsuredName}, '%')
            </if>
        </where>
    </select>

    <select id="selectById" resultMap="jiashiyuanBaoxianResultMap" parameterType="java.lang.String">
        select ajb.*,bd.dept_name from anbiao_jiashiyuan_baoxian ajb
        LEFT JOIN blade_dept bd ON bd.id = ajb.ajb_dept_ids
        where ajb_delete = 0 and  ajb.ajb_ids= #{ajbIds}
    </select>

    <select id="queryByMax" resultMap="jiashiyuanBaoxianResultMap" parameterType="java.lang.String">
        select ajb.*,bd.dept_name from anbiao_jiashiyuan_baoxian ajb
        LEFT JOIN blade_dept bd ON bd.id = ajb.ajb_dept_ids
        where ajb_delete = 0 and  ajb.ajb_insured_ids= #{driverId}
        ORDER BY ajb.ajb_insurance_period_end DESC LIMIT 1
    </select>


    <select id="getDeptUser" resultType="org.springblade.system.user.entity.User" >
        select
            DISTINCT
            u.id,p.id as postId,gangwei.id as gangweiid,bumen.id as bumenid,jigou.id as jigouid,
            u.name as name,
            u.real_name as realName,
            u.account,
            CONCAT(jigou.dept_name,case when bumen.dept_name is null then '' else concat('/',bumen.dept_name)end,'/',gangwei.dept_name) as deptName,
            gangwei.dept_name as postName,
            u.phone,
            case
                when ifnull(u.is_deleted,0) = 0 then '启用'
                when ifnull(u.is_deleted,0) = 1 then '删除'
                when ifnull(u.is_deleted,0) = 2 then '禁用'
                end as zhuangtai,
            u.create_time as createTimes,
            u.update_time as updateTimes,
            ux.jiatingdizhi as address,
            u.password
        from
            blade_user u
                INNER JOIN anbiao_personnel ux on ux.userid = u.id and ux.is_deleted = 0
                INNER JOIN blade_post p ON u.id=p.user_id
                INNER JOIN blade_dept gangwei ON p.post_id=gangwei.id
                LEFT JOIN blade_dept bumen ON gangwei.parent_id = bumen.id and bumen.extend_type='部门'
                INNER JOIN blade_dept jigou ON (gangwei.parent_id=jigou.id or bumen.parent_id=jigou.id) and jigou.extend_type='机构'
                INNER JOIN blade_dept shangji ON locate(shangji.tree_code,jigou.tree_code)>0 and shangji.id=#{deptId}
        where u.is_deleted != 1
            and IFNULL(account,'') != ''
    </select>

    <select id="QiYeList" resultType="org.springblade.system.entity.Dept">
        select
            DISTINCT
            a.id,
            a.dept_name,
            b.jigoubianma
        from(
                SELECT
                    DISTINCT
                    xiaji.id,
                    xiaji.parent_id,
                    xiaji.dept_name,
                    xiaji.is_deleted
                FROM
                    blade_dept shangji,
                    blade_dept xiaji
                WHERE xiaji.tree_code LIKE CONCAT(shangji.tree_code,'%')
                  AND xiaji.is_deleted = 0 AND xiaji.extend_type='机构'
                  AND shangji.id= #{deptId}
                )a
                INNER JOIN(
            select dept_id,jigoubianma from anbiao_organization
            where isdelete = 0 and jigouleixing in ('qiye','geti')
            )b on a.id = b.dept_id
        ORDER BY a.dept_name asc
    </select>

    <select id="selectLedgerPage"
            parameterType="org.springblade.anbiao.jiashiyuan.page.JiaShiYuanLedgerPage"
            resultType="org.springblade.anbiao.jiashiyuan.vo.JiaShiYuanLedgerVO">
        <if test="size == 0" >
            SELECT
            a.id as deptId,
            a.dept_name as deptName,
            b.jiashiyuanrenshu,
            c.cheliangshuliang,
            d.yiwaixianzongbaoxianjine,
            d.yiwaixianzongbaofeijine ,
            e.chexianzongbaoxianjine,
            e.chexianzongbaofeijine,
            f.jiaoqiangxianzongjine,
            f.jiaoqiangxianzongbaofeijine,
            g.huoguizongbaoxianjine,
            g.huoguizongbaofeijine,
            h.anzezongbaoxianjine,
            h.anzezongbaofeijine,
            i.qitazongbaoxianjine,
            i.qitazongbaofeijine,
            j.qitazongbaoxianjine as qitazongbaoxianjineqiye,
            j.qitazongbaofeijine as qitazongbaofeijineqiye,
            IFNULL(d.yiwaixianzongbaoxianjine,0)+IFNULL(d.yiwaixianzongbaofeijine,0)+IFNULL(e.chexianzongbaoxianjine,0)+IFNULL( e.chexianzongbaofeijine,0)+IFNULL(f.jiaoqiangxianzongjine,0)+IFNULL(f.jiaoqiangxianzongbaofeijine,0)+IFNULL(g.huoguizongbaoxianjine,0)+IFNULL(g.huoguizongbaofeijine,0)+IFNULL(h.anzezongbaoxianjine,0)+IFNULL(h.anzezongbaofeijine,0)+IFNULL( i.qitazongbaoxianjine,0)+IFNULL(i.qitazongbaofeijine,0)+IFNULL(j.qitazongbaoxianjine,0)+IFNULL(j.qitazongbaofeijine ,0) as totalTmount
            FROM
            (
            <include
                refid="org.springblade.anbiao.guanlijigouherenyuan.mapper.OrganizationsMapper.getByDeptId"/>
            ) a
            INNER JOIN anbiao_organization k on a.id = k.dept_id and k.jigouleixing in('qiye','geti')
            LEFT JOIN ( SELECT dept_id, COUNT( id ) AS jiashiyuanrenshu FROM anbiao_jiashiyuan WHERE  isdelete = 0 GROUP BY dept_id) b ON b.dept_id = a.id
            LEFT JOIN ( SELECT dept_id, COUNT( id ) AS cheliangshuliang FROM anbiao_vehicle WHERE  is_deleted = 0 GROUP BY dept_id) c ON c.dept_id = a.id
            -- 意外险
            LEFT JOIN (
            SELECT
            ajb_dept_ids,
            sum(d.yiwaixianzongbaoxianjine) as yiwaixianzongbaoxianjine ,
            sum(d.yiwaixianzongbaofeijine) as  yiwaixianzongbaofeijine
            FROM
            anbiao_jiashiyuan_baoxian
            LEFT JOIN ( SELECT ajbm_avb_ids,SUM( ajbm_company_amount ) AS yiwaixianzongbaoxianjine, SUM( ajbm_basic_premium ) AS yiwaixianzongbaofeijine FROM anbiao_jiashiyuan_baoxian_mingxi WHERE ajbm_risk = "意外险" GROUP BY ajbm_avb_ids) d ON ajb_ids = d.ajbm_avb_ids
            WHERE
            ajb_delete=0
            <if test="date != null and date != ''">
                and ajb_insurance_period_start >= #{date}
            </if>
            GROUP BY ajb_dept_ids
            ) d ON d.ajb_dept_ids = a.id

            -- 车险
            LEFT JOIN (
            SELECT
            avb_dept_ids,
            sum(d.chexianzongbaoxianjine) as chexianzongbaoxianjine,
            sum(d.chexianzongbaofeijine ) as chexianzongbaofeijine
            FROM
            anbiao_vehicle_baoxian
            LEFT JOIN ( SELECT avbm_avb_ids,sum(avbm_insurance_amount) AS chexianzongbaoxianjine, sum(avbm_basic_premium) AS chexianzongbaofeijine FROM anbiao_vehicle_baoxian_mingxi WHERE avbm_risk != "交强险"  GROUP BY avbm_avb_ids) d ON avb_ids = d.avbm_avb_ids
            WHERE
            avb_delete=0
            <if test="date != null and date != ''">
                and avb_insurance_period_start >= #{date}
            </if>
            GROUP BY avb_dept_ids
            )e on e.avb_dept_ids	=a.id

            -- 交强险
            LEFT JOIN (
            SELECT
            avb_dept_ids,
            sum(d.jiaoqiangxianzongjine) as jiaoqiangxianzongjine,
            sum(d.jiaoqiangxianzongbaofeijine ) as jiaoqiangxianzongbaofeijine
            FROM
            anbiao_vehicle_baoxian
            LEFT JOIN ( SELECT avbm_avb_ids,sum(avbm_insurance_amount) AS jiaoqiangxianzongjine, sum(avbm_basic_premium) AS jiaoqiangxianzongbaofeijine FROM anbiao_vehicle_baoxian_mingxi WHERE avbm_risk = "交强险"  GROUP BY avbm_avb_ids) d ON avb_ids = d.avbm_avb_ids
            WHERE
            avb_delete=0
            <if test="date != null and date != ''">
                and avb_insurance_period_start >= #{date}
            </if>
            GROUP BY avb_dept_ids
            )f on f.avb_dept_ids	=a.id

            -- 货柜险
            LEFT JOIN (
            SELECT
            avb_dept_ids,
            sum(d.huoguizongbaoxianjine) as huoguizongbaoxianjine,
            sum(d.huoguizongbaofeijine ) as huoguizongbaofeijine
            FROM
            anbiao_dept_baoxian
            LEFT JOIN ( SELECT avbm_avb_ids,sum(avbm_insurance_amount) AS huoguizongbaoxianjine, sum(avbm_basic_premium) AS huoguizongbaofeijine FROM anbiao_dept_baoxian_mingxi WHERE avbm_risk = "货柜险"  GROUP BY avbm_avb_ids) d ON avb_ids = d.avbm_avb_ids
            WHERE
            avb_delete=0
            <if test="date != null and date != ''">
                and avb_insurance_period_start >= #{date}
            </if>
            GROUP BY avb_dept_ids
            )g on g.avb_dept_ids	=a.id

            -- 安责险
            LEFT JOIN (
            SELECT
            avb_dept_ids,
            sum(d.anzezongbaoxianjine) as anzezongbaoxianjine,
            sum(d.anzezongbaofeijine ) as anzezongbaofeijine
            FROM
            anbiao_dept_baoxian
            LEFT JOIN ( SELECT avbm_avb_ids,sum(avbm_insurance_amount) AS anzezongbaoxianjine, sum(avbm_basic_premium) AS anzezongbaofeijine FROM anbiao_dept_baoxian_mingxi WHERE avbm_risk = "安责险"  GROUP BY avbm_avb_ids) d ON avb_ids = d.avbm_avb_ids
            WHERE
            avb_delete=0
            <if test="date != null and date != ''">
                and avb_insurance_period_start >= #{date}
            </if>
            GROUP BY avb_dept_ids
            )h on h.avb_dept_ids	=a.id

            -- 其他（人员）
            LEFT JOIN (
            SELECT
            ajb_dept_ids,
            sum(d.qitazongbaoxianjine) as qitazongbaoxianjine ,
            sum(d.qitazongbaofeijine) as  qitazongbaofeijine
            FROM
            anbiao_jiashiyuan_baoxian
            LEFT JOIN ( SELECT ajbm_avb_ids,SUM( ajbm_company_amount ) AS qitazongbaoxianjine, SUM( ajbm_basic_premium ) AS qitazongbaofeijine FROM anbiao_jiashiyuan_baoxian_mingxi WHERE ajbm_risk != "意外险" GROUP BY ajbm_avb_ids) d ON ajb_ids = d.ajbm_avb_ids
            WHERE
            ajb_delete=0
            <if test="date != null and date != ''">
                and ajb_insurance_period_start >= #{date}
            </if>
            GROUP BY ajb_dept_ids
            ) i ON i.ajb_dept_ids = a.id

            -- 其他（企业）
            LEFT JOIN (
            SELECT
            avb_dept_ids,
            sum(d.qitazongbaoxianjine) as qitazongbaoxianjine,
            sum(d.qitazongbaofeijine ) as qitazongbaofeijine
            FROM
            anbiao_dept_baoxian
            LEFT JOIN ( SELECT avbm_avb_ids,sum(avbm_insurance_amount) AS qitazongbaoxianjine, sum(avbm_basic_premium) AS qitazongbaofeijine FROM anbiao_dept_baoxian_mingxi WHERE avbm_risk != "安责险" and avbm_risk != "货柜险" GROUP BY avbm_avb_ids) d ON avb_ids = d.avbm_avb_ids
            WHERE
            avb_delete=0
            <if test="date != null and date != ''">
                and avb_insurance_period_start >= #{date}
            </if>
            GROUP BY avb_dept_ids
            )j on j.avb_dept_ids	=a.id

            where 1=1
            <if test="deptName != null and deptName != ''">
                AND a.dept_name like '%${deptName}%'
            </if>
            limit ${total}
        </if>
        <if test="current != 0" >
            SELECT
            a.id as deptId,
            a.dept_name as deptName,
            b.jiashiyuanrenshu,
            c.cheliangshuliang,
            d.yiwaixianzongbaoxianjine,
            d.yiwaixianzongbaofeijine ,
            e.chexianzongbaoxianjine,
            e.chexianzongbaofeijine,
            f.jiaoqiangxianzongjine,
            f.jiaoqiangxianzongbaofeijine,
            g.huoguizongbaoxianjine,
            g.huoguizongbaofeijine,
            h.anzezongbaoxianjine,
            h.anzezongbaofeijine,
            i.qitazongbaoxianjine,
            i.qitazongbaofeijine,
            j.qitazongbaoxianjine as qitazongbaoxianjineqiye,
            j.qitazongbaofeijine as qitazongbaofeijineqiye,
            IFNULL(d.yiwaixianzongbaoxianjine,0)+IFNULL(d.yiwaixianzongbaofeijine,0)+IFNULL(e.chexianzongbaoxianjine,0)+IFNULL( e.chexianzongbaofeijine,0)+IFNULL(f.jiaoqiangxianzongjine,0)+IFNULL(f.jiaoqiangxianzongbaofeijine,0)+IFNULL(g.huoguizongbaoxianjine,0)+IFNULL(g.huoguizongbaofeijine,0)+IFNULL(h.anzezongbaoxianjine,0)+IFNULL(h.anzezongbaofeijine,0)+IFNULL( i.qitazongbaoxianjine,0)+IFNULL(i.qitazongbaofeijine,0)+IFNULL(j.qitazongbaoxianjine,0)+IFNULL(j.qitazongbaofeijine ,0) as totalTmount
            FROM
            (
            <include
                refid="org.springblade.anbiao.guanlijigouherenyuan.mapper.OrganizationsMapper.getByDeptId"/>
            ) a
            INNER JOIN anbiao_organization k on a.id = k.dept_id and k.jigouleixing in('qiye','geti')
            LEFT JOIN ( SELECT dept_id, COUNT( id ) AS jiashiyuanrenshu FROM anbiao_jiashiyuan WHERE  isdelete = 0 GROUP BY dept_id) b ON b.dept_id = a.id
            LEFT JOIN ( SELECT dept_id, COUNT( id ) AS cheliangshuliang FROM anbiao_vehicle WHERE  is_deleted = 0 GROUP BY dept_id) c ON c.dept_id = a.id
            -- 意外险
            LEFT JOIN (
            SELECT
            ajb_dept_ids,
            sum(d.yiwaixianzongbaoxianjine) as yiwaixianzongbaoxianjine ,
            sum(d.yiwaixianzongbaofeijine) as  yiwaixianzongbaofeijine
            FROM
            anbiao_jiashiyuan_baoxian
            LEFT JOIN ( SELECT ajbm_avb_ids,SUM( ajbm_company_amount ) AS yiwaixianzongbaoxianjine, SUM( ajbm_basic_premium ) AS yiwaixianzongbaofeijine FROM anbiao_jiashiyuan_baoxian_mingxi WHERE ajbm_risk = "意外险" GROUP BY ajbm_avb_ids) d ON ajb_ids = d.ajbm_avb_ids
            WHERE
            ajb_delete=0
            <if test="date != null and date != ''">
                and ajb_insurance_period_start >= #{date}
            </if>
            GROUP BY ajb_dept_ids
            ) d ON d.ajb_dept_ids = a.id

            -- 车险
            LEFT JOIN (
            SELECT
            avb_dept_ids,
            sum(d.chexianzongbaoxianjine) as chexianzongbaoxianjine,
            sum(d.chexianzongbaofeijine ) as chexianzongbaofeijine
            FROM
            anbiao_vehicle_baoxian
            LEFT JOIN ( SELECT avbm_avb_ids,sum(avbm_insurance_amount) AS chexianzongbaoxianjine, sum(avbm_basic_premium) AS chexianzongbaofeijine FROM anbiao_vehicle_baoxian_mingxi WHERE avbm_risk != "交强险"  GROUP BY avbm_avb_ids) d ON avb_ids = d.avbm_avb_ids
            WHERE
            avb_delete=0
            <if test="date != null and date != ''">
                and avb_insurance_period_start >= #{date}
            </if>
            GROUP BY avb_dept_ids
            )e on e.avb_dept_ids	=a.id

            -- 交强险
            LEFT JOIN (
            SELECT
            avb_dept_ids,
            sum(d.jiaoqiangxianzongjine) as jiaoqiangxianzongjine,
            sum(d.jiaoqiangxianzongbaofeijine ) as jiaoqiangxianzongbaofeijine
            FROM
            anbiao_vehicle_baoxian
            LEFT JOIN ( SELECT avbm_avb_ids,sum(avbm_insurance_amount) AS jiaoqiangxianzongjine, sum(avbm_basic_premium) AS jiaoqiangxianzongbaofeijine FROM anbiao_vehicle_baoxian_mingxi WHERE avbm_risk = "交强险"  GROUP BY avbm_avb_ids) d ON avb_ids = d.avbm_avb_ids
            WHERE
            avb_delete=0
            <if test="date != null and date != ''">
                and avb_insurance_period_start >= #{date}
            </if>
            GROUP BY avb_dept_ids
            )f on f.avb_dept_ids	=a.id

            -- 货柜险
            LEFT JOIN (
            SELECT
            avb_dept_ids,
            sum(d.huoguizongbaoxianjine) as huoguizongbaoxianjine,
            sum(d.huoguizongbaofeijine ) as huoguizongbaofeijine
            FROM
            anbiao_dept_baoxian
            LEFT JOIN ( SELECT avbm_avb_ids,sum(avbm_insurance_amount) AS huoguizongbaoxianjine, sum(avbm_basic_premium) AS huoguizongbaofeijine FROM anbiao_dept_baoxian_mingxi WHERE avbm_risk = "货柜险"  GROUP BY avbm_avb_ids) d ON avb_ids = d.avbm_avb_ids
            WHERE
            avb_delete=0
            <if test="date != null and date != ''">
                and avb_insurance_period_start >= #{date}
            </if>
            GROUP BY avb_dept_ids
            )g on g.avb_dept_ids	=a.id

            -- 安责险
            LEFT JOIN (
            SELECT
            avb_dept_ids,
            sum(d.anzezongbaoxianjine) as anzezongbaoxianjine,
            sum(d.anzezongbaofeijine ) as anzezongbaofeijine
            FROM
            anbiao_dept_baoxian
            LEFT JOIN ( SELECT avbm_avb_ids,sum(avbm_insurance_amount) AS anzezongbaoxianjine, sum(avbm_basic_premium) AS anzezongbaofeijine FROM anbiao_dept_baoxian_mingxi WHERE avbm_risk = "安责险"  GROUP BY avbm_avb_ids) d ON avb_ids = d.avbm_avb_ids
            WHERE
            avb_delete=0
            <if test="date != null and date != ''">
                and avb_insurance_period_start >= #{date}
            </if>
            GROUP BY avb_dept_ids
            )h on h.avb_dept_ids	=a.id

            -- 其他（人员）
            LEFT JOIN (
            SELECT
            ajb_dept_ids,
            sum(d.qitazongbaoxianjine) as qitazongbaoxianjine ,
            sum(d.qitazongbaofeijine) as  qitazongbaofeijine
            FROM
            anbiao_jiashiyuan_baoxian
            LEFT JOIN ( SELECT ajbm_avb_ids,SUM( ajbm_company_amount ) AS qitazongbaoxianjine, SUM( ajbm_basic_premium ) AS qitazongbaofeijine FROM anbiao_jiashiyuan_baoxian_mingxi WHERE ajbm_risk != "意外险" GROUP BY ajbm_avb_ids) d ON ajb_ids = d.ajbm_avb_ids
            WHERE
            ajb_delete=0
            <if test="date != null and date != ''">
                and ajb_insurance_period_start >= #{date}
            </if>
            GROUP BY ajb_dept_ids
            ) i ON i.ajb_dept_ids = a.id

            -- 其他（企业）
            LEFT JOIN (
            SELECT
            avb_dept_ids,
            sum(d.qitazongbaoxianjine) as qitazongbaoxianjine,
            sum(d.qitazongbaofeijine ) as qitazongbaofeijine
            FROM
            anbiao_dept_baoxian
            LEFT JOIN ( SELECT avbm_avb_ids,sum(avbm_insurance_amount) AS qitazongbaoxianjine, sum(avbm_basic_premium) AS qitazongbaofeijine FROM anbiao_dept_baoxian_mingxi WHERE avbm_risk != "安责险" and avbm_risk != "货柜险" GROUP BY avbm_avb_ids) d ON avb_ids = d.avbm_avb_ids
            WHERE
            avb_delete=0
            <if test="date != null and date != ''">
                and avb_insurance_period_start >= #{date}
            </if>
            GROUP BY avb_dept_ids
            )j on j.avb_dept_ids	=a.id

            where 1=1
            <if test="deptName != null and deptName != ''">
                AND a.dept_name like '%${deptName}%'
            </if>
            limit ${offsetNo},${size}
        </if>
    </select>

    <select id="selectLedgerTotal"
            parameterType="org.springblade.anbiao.jiashiyuan.page.JiaShiYuanLedgerPage"
            resultType="int">
        select COUNT(1) from(
        SELECT
        a.id as deptId,
        a.dept_name as deptName,
        b.jiashiyuanrenshu,
        c.cheliangshuliang,
        d.yiwaixianzongbaoxianjine,
        d.yiwaixianzongbaofeijine ,
        e.chexianzongbaoxianjine,
        e.chexianzongbaofeijine,
        f.jiaoqiangxianzongjine,
        f.jiaoqiangxianzongbaofeijine,
        g.huoguizongbaoxianjine,
        g.huoguizongbaofeijine,
        h.anzezongbaoxianjine,
        h.anzezongbaofeijine,
        i.qitazongbaoxianjine,
        i.qitazongbaofeijine,
        j.qitazongbaoxianjine as qitazongbaoxianjineqiye,
        j.qitazongbaofeijine as qitazongbaofeijineqiye,
        IFNULL(d.yiwaixianzongbaoxianjine,0)+IFNULL(d.yiwaixianzongbaofeijine,0)+IFNULL(e.chexianzongbaoxianjine,0)+IFNULL( e.chexianzongbaofeijine,0)+IFNULL(f.jiaoqiangxianzongjine,0)+IFNULL(f.jiaoqiangxianzongbaofeijine,0)+IFNULL(g.huoguizongbaoxianjine,0)+IFNULL(g.huoguizongbaofeijine,0)+IFNULL(h.anzezongbaoxianjine,0)+IFNULL(h.anzezongbaofeijine,0)+IFNULL( i.qitazongbaoxianjine,0)+IFNULL(i.qitazongbaofeijine,0)+IFNULL(j.qitazongbaoxianjine,0)+IFNULL(j.qitazongbaofeijine ,0) as totalTmount
        FROM
        (
        <include
            refid="org.springblade.anbiao.guanlijigouherenyuan.mapper.OrganizationsMapper.getByDeptId"/>
        ) a
        INNER JOIN anbiao_organization k on a.id = k.dept_id and k.jigouleixing in('qiye','geti')
        LEFT JOIN ( SELECT dept_id, COUNT( id ) AS jiashiyuanrenshu FROM anbiao_jiashiyuan WHERE  isdelete = 0 GROUP BY dept_id) b ON b.dept_id = a.id
        LEFT JOIN ( SELECT dept_id, COUNT( id ) AS cheliangshuliang FROM anbiao_vehicle WHERE  is_deleted = 0 GROUP BY dept_id) c ON c.dept_id = a.id
        -- 意外险
        LEFT JOIN (
        SELECT
        ajb_dept_ids,
        sum(d.yiwaixianzongbaoxianjine) as yiwaixianzongbaoxianjine ,
        sum(d.yiwaixianzongbaofeijine) as  yiwaixianzongbaofeijine
        FROM
        anbiao_jiashiyuan_baoxian
        LEFT JOIN ( SELECT ajbm_avb_ids,SUM( ajbm_company_amount ) AS yiwaixianzongbaoxianjine, SUM( ajbm_basic_premium ) AS yiwaixianzongbaofeijine FROM anbiao_jiashiyuan_baoxian_mingxi WHERE ajbm_risk = "意外险" GROUP BY ajbm_avb_ids) d ON ajb_ids = d.ajbm_avb_ids
        WHERE
        ajb_delete=0
        <if test="date != null and date != ''">
            and ajb_insurance_period_start >= #{date}
        </if>
        GROUP BY ajb_dept_ids
        ) d ON d.ajb_dept_ids = a.id

        -- 车险
        LEFT JOIN (
        SELECT
        avb_dept_ids,
        sum(d.chexianzongbaoxianjine) as chexianzongbaoxianjine,
        sum(d.chexianzongbaofeijine ) as chexianzongbaofeijine
        FROM
        anbiao_vehicle_baoxian
        LEFT JOIN ( SELECT avbm_avb_ids,sum(avbm_insurance_amount) AS chexianzongbaoxianjine, sum(avbm_basic_premium) AS chexianzongbaofeijine FROM anbiao_vehicle_baoxian_mingxi WHERE avbm_risk != "交强险"  GROUP BY avbm_avb_ids) d ON avb_ids = d.avbm_avb_ids
        WHERE
        avb_delete=0
        <if test="date != null and date != ''">
            and avb_insurance_period_start >= #{date}
        </if>
        GROUP BY avb_dept_ids
        )e on e.avb_dept_ids	=a.id

        -- 交强险
        LEFT JOIN (
        SELECT
        avb_dept_ids,
        sum(d.jiaoqiangxianzongjine) as jiaoqiangxianzongjine,
        sum(d.jiaoqiangxianzongbaofeijine ) as jiaoqiangxianzongbaofeijine
        FROM
        anbiao_vehicle_baoxian
        LEFT JOIN ( SELECT avbm_avb_ids,sum(avbm_insurance_amount) AS jiaoqiangxianzongjine, sum(avbm_basic_premium) AS jiaoqiangxianzongbaofeijine FROM anbiao_vehicle_baoxian_mingxi WHERE avbm_risk = "交强险"  GROUP BY avbm_avb_ids) d ON avb_ids = d.avbm_avb_ids
        WHERE
        avb_delete=0
        <if test="date != null and date != ''">
            and avb_insurance_period_start >= #{date}
        </if>
        GROUP BY avb_dept_ids
        )f on f.avb_dept_ids	=a.id

        -- 货柜险
        LEFT JOIN (
        SELECT
        avb_dept_ids,
        sum(d.huoguizongbaoxianjine) as huoguizongbaoxianjine,
        sum(d.huoguizongbaofeijine ) as huoguizongbaofeijine
        FROM
        anbiao_dept_baoxian
        LEFT JOIN ( SELECT avbm_avb_ids,sum(avbm_insurance_amount) AS huoguizongbaoxianjine, sum(avbm_basic_premium) AS huoguizongbaofeijine FROM anbiao_dept_baoxian_mingxi WHERE avbm_risk = "货柜险"  GROUP BY avbm_avb_ids) d ON avb_ids = d.avbm_avb_ids
        WHERE
        avb_delete=0
        <if test="date != null and date != ''">
            and avb_insurance_period_start >= #{date}
        </if>
        GROUP BY avb_dept_ids
        )g on g.avb_dept_ids	=a.id

        -- 安责险
        LEFT JOIN (
        SELECT
        avb_dept_ids,
        sum(d.anzezongbaoxianjine) as anzezongbaoxianjine,
        sum(d.anzezongbaofeijine ) as anzezongbaofeijine
        FROM
        anbiao_dept_baoxian
        LEFT JOIN ( SELECT avbm_avb_ids,sum(avbm_insurance_amount) AS anzezongbaoxianjine, sum(avbm_basic_premium) AS anzezongbaofeijine FROM anbiao_dept_baoxian_mingxi WHERE avbm_risk = "安责险"  GROUP BY avbm_avb_ids) d ON avb_ids = d.avbm_avb_ids
        WHERE
        avb_delete=0
        <if test="date != null and date != ''">
            and avb_insurance_period_start >= #{date}
        </if>
        GROUP BY avb_dept_ids
        )h on h.avb_dept_ids	=a.id

        -- 其他（人员）
        LEFT JOIN (
        SELECT
        ajb_dept_ids,
        sum(d.qitazongbaoxianjine) as qitazongbaoxianjine ,
        sum(d.qitazongbaofeijine) as  qitazongbaofeijine
        FROM
        anbiao_jiashiyuan_baoxian
        LEFT JOIN ( SELECT ajbm_avb_ids,SUM( ajbm_company_amount ) AS qitazongbaoxianjine, SUM( ajbm_basic_premium ) AS qitazongbaofeijine FROM anbiao_jiashiyuan_baoxian_mingxi WHERE ajbm_risk != "意外险" GROUP BY ajbm_avb_ids) d ON ajb_ids = d.ajbm_avb_ids
        WHERE
        ajb_delete=0
        <if test="date != null and date != ''">
            and ajb_insurance_period_start >= #{date}
        </if>
        GROUP BY ajb_dept_ids
        ) i ON i.ajb_dept_ids = a.id

        -- 其他（企业）
        LEFT JOIN (
        SELECT
        avb_dept_ids,
        sum(d.qitazongbaoxianjine) as qitazongbaoxianjine,
        sum(d.qitazongbaofeijine ) as qitazongbaofeijine
        FROM
        anbiao_dept_baoxian
        LEFT JOIN ( SELECT avbm_avb_ids,sum(avbm_insurance_amount) AS qitazongbaoxianjine, sum(avbm_basic_premium) AS qitazongbaofeijine FROM anbiao_dept_baoxian_mingxi WHERE avbm_risk != "安责险" and avbm_risk != "货柜险" GROUP BY avbm_avb_ids) d ON avb_ids = d.avbm_avb_ids
        WHERE
        avb_delete=0
        <if test="date != null and date != ''">
            and avb_insurance_period_start >= #{date}
        </if>
        GROUP BY avb_dept_ids
        )j on j.avb_dept_ids	=a.id

        where 1=1
        <if test="deptName != null and deptName != ''">
            AND a.dept_name like '%${deptName}%'
        </if>
        ) d

    </select>
</mapper>
