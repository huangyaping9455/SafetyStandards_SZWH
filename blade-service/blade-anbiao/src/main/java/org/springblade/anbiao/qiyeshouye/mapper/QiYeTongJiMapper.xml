<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.springblade.anbiao.qiyeshouye.mapper.QiYeTongJiMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="DeptPersistentUnpositioningTongJiResultMap" type="org.springblade.anbiao.qiyeshouye.entity.DeptPersistentUnpositioningTongJi">
    </resultMap>

    <resultMap id="DeptPiLaoBaoJingTongJiResultMap" type="org.springblade.anbiao.qiyeshouye.entity.DeptPiLaoBaoJingTongJi">
    </resultMap>

    <resultMap id="DeptChaoSuBaoJingTongJiResultMap" type="org.springblade.anbiao.qiyeshouye.entity.DeptChaoSuBaoJingTongJi">
    </resultMap>

    <resultMap id="DeptBaoJingTongJiLvResultMap" type="org.springblade.anbiao.qiyeshouye.entity.DeptBaoJingTongJiLv">
    </resultMap>

    <resultMap id="ResultMap" type="org.springblade.anbiao.qiyeshouye.entity.QiYeTongJi">
    </resultMap>

    <resultMap id="RYXResultMap" type="org.springblade.anbiao.qiyeshouye.entity.QiYeRiYunXingTongJi">
    </resultMap>

    <resultMap id="OffLineResultMap" type="org.springblade.anbiao.qiyeshouye.entity.QiYeOffLineTongJi">
    </resultMap>

    <resultMap id="InOutAreaResultMap" type="org.springblade.anbiao.qiyeshouye.entity.QiYeInOutAreaTongJi">
    </resultMap>

    <resultMap id="statementResultMap" type="org.springblade.anbiao.qiyeshouye.entity.StatementTongJi">
    </resultMap>

    <resultMap id="TrajectoryAnomaliesResultMap" type="org.springblade.anbiao.qiyeshouye.entity.TrajectoryAnomalies">
    </resultMap>

    <resultMap id="StopVehicleResultMap" type="org.springblade.anbiao.qiyeshouye.entity.StopVehicle">
    </resultMap>

    <resultMap id="TpvehdataResultMap" type="org.springblade.anbiao.qiyeshouye.entity.QiYeTpvehdataTongJi">
    </resultMap>

    <resultMap id="JiashiyuanDakaInfoBaseResultMap" type="org.springblade.anbiao.qiyeshouye.entity.JiashiyuanDakaInfo">
    </resultMap>


    <!-- 查询报警统计汇总列表 -->
    <sql id="tableSql">
        select
            concat(#{beginTime},'至',#{endTime}) as date,
            ROUND(b.baojingcishu/d.baojingcheliangshu,2) as danchebaojingbi,
            b.*,
            c.*,
            IFNULL(d.baojingcheliangshu,0) as baojingcheliangshu
        from(
            select
                cid,
                company,
                SUM(IFNULL(baojingcishu,0)) as baojingcishu,
				SUM(IFNULL(zhudongbaojingcishu,0)) as zhudongbaojingcishu,
				SUM(IFNULL(baojingcishu,0)) - SUM(IFNULL(zhudongbaojingcishu,0)) as beidoubaojingcishu,
                IFNULL(SUM(chaosu),0) as chaosu,
                IFNULL(SUM(pilao),0) as pilao,
                IFNULL(SUM(yejian),0) as yejian,
                IFNULL(SUM(buzaixian+budingwei),0) as yichang,
                IFNULL(SUM(dadianhua),0) as dmsdadianhua,
                IFNULL(SUM(chouyan),0) as dmschouyan,
                IFNULL(SUM(fenshen),0) as dmsfenshen,
                IFNULL(SUM(pilaoshipin),0) as dmspilao
            from
                baobiao_alarmvehdailyreport
            where 1=1
                and cid = #{deptId}
                and date &gt;= #{beginTime}
                and date &lt;= #{endTime}
            GROUP BY
                cid,
                company
            )b
        left join(
            select
                dept_id,
                COUNT(cheliangpaizhao) as cheliangshu
            from
                anbiao_vehicle
            where 1=1
                and IFNULL(cheliangzhuangtai,0) = 0
                and is_deleted = 0
                and dept_id = #{deptId}
            GROUP BY
                dept_id
            )c on c.dept_id = b.cid
        left join(
            select
                cid,
                company,
                IFNULL(COUNT(cheliangpaizhao),0) as baojingcheliangshu
            from
                baobiao_alarmvehdailyreport
                where 1=1
                    and date &gt;= #{beginTime}
                    and date &lt;= #{endTime}
                    and IFNULL(baojingcishu,0) > 0
            GROUP BY
                cid,
                company
            )d on d.cid = b.cid
        where 1=1
    </sql>

    <sql id="orderSql">
        <!-- 默认排序规则 -->
        <if test="orderColumn == null or orderColumn == ''">
            order by baojingcishu desc
        </if>
        <if test="orderColumn != null and orderColumn != ''">
            order by ${orderColumn}
        </if>
        <if test="orderColumn != null and orderColumn != '' and order != 0">
            desc
        </if>
        <if test="orderColumn != null and orderColumn != '' and order == 0">
            asc
        </if>
    </sql>

    <sql id="querySql">
        <if test="shifouchuli != null and shifouchuli != '' ">
            <if test="shifouchuli=='已处理'">
                and chulizhuangtai = '已处理'
            </if>
            <if test="shifouchuli=='未处理'">
                and ifnull(chulizhuangtai,'') = '未处理'
            </if>
        </if>

        <if test="shifoushenshu != null and shifoushenshu != '' ">
            <if test="shifoushenshu=='已申诉'">
                and shensuzhuangtai = '已申诉'
            </if>
            <if test="shifoushenshu=='未申诉'">
                and ifnull(shensuzhuangtai,'') = '未申诉'
            </if>
        </if>

        <if test="cheliangpaizhao != null and cheliangpaizhao != ''">
            and cheliangpaizhao = #{cheliangpaizhao}
        </if>

        <if test="deptName != null and deptName != ''">
            and company like '%${deptName}%'
        </if>

    </sql>

    <select timeout="600" id="selectGetBJTJ" resultMap="ResultMap"
            parameterType="org.springblade.anbiao.qiyeshouye.page.QiYeTongJiPage">
        <if test="size == 0">
            select * from (
            <include refid="tableSql"/>
            )b
            where 1=1
            <include refid="querySql"/>
            <include refid="orderSql"/>
            limit ${total}
        </if>
        <if test="current != 0">
            select * from (
            <include refid="tableSql"/>
            )b
            where 1=1
            <include refid="querySql"/>
            <include refid="orderSql"/>
            limit ${offsetNo},${size}
        </if>
    </select>

    <select timeout="90" id="selectGetBJTJTotal"
            parameterType="org.springblade.anbiao.qiyeshouye.page.QiYeTongJiPage"
            resultType="int">
        select COUNT(1) from (
        <include refid="tableSql"/>
        )d where 1 = 1
        <include refid="querySql"/>
    </select>


    <!-- 查询车辆报警排名列表 -->
    <sql id="tablePMSql">
        select
            concat(#{beginTime},'至',#{endTime}) as date,
            b.*,
            c.shiyongxingzhi
        from(
            select
                cid,
                company,
                cheliangpaizhao,
                chepaiyanse,
                SUM(IFNULL(baojingcishu,0)) as baojingcishu,
                SUM(IFNULL(zhudongbaojingcishu,0)) as zhudongbaojingcishu,
                SUM(IFNULL(baojingcishu,0))- SUM(IFNULL(zhudongbaojingcishu,0)) as beidoubaojingcishu,
                SUM(IFNULL(chaosu,0)) as chaosu,
                SUM(IFNULL(pilao,0)) as pilao,
                SUM(IFNULL(yejian,0)) as yejian,
                SUM(IFNULL(buzaixian+budingwei,0)) as yichang,
                SUM(IFNULL(dadianhua,0)) as dmsdadianhua,
                SUM(IFNULL(chouyan,0)) as dmschouyan,
                SUM(IFNULL(fenshen,0)) as dmsfenshen,
                SUM(IFNULL(pilaoshipin,0)) as dmspilao
            from
                baobiao_alarmvehdailyreport
            where 1=1
                and cid = #{deptId}
                and date &gt;= #{beginTime}
                and date &lt;= #{endTime}
                and IFNULL(baojingcishu,0) &gt; 0
            GROUP BY
                cid,
                company,
                cheliangpaizhao,
                chepaiyanse
            )b
        inner join(
            select
                dept_id,
                cheliangpaizhao,
                chepaiyanse,
                shiyongxingzhi
            from
                anbiao_vehicle
            where IFNULL(cheliangzhuangtai,0) = 0
                and is_deleted = 0
                and dept_id = #{deptId}
            GROUP BY
                dept_id,
                cheliangpaizhao,
                chepaiyanse,
                shiyongxingzhi
            )c on c.dept_id = b.cid
        where 1=1
            and c.cheliangpaizhao = b.cheliangpaizhao
            and c.chepaiyanse = b.chepaiyanse
    </sql>

    <sql id="orderPMSql">
        <!-- 默认排序规则 -->
        <if test="orderColumn == null or orderColumn == ''">
            order by baojingcishu desc
        </if>
        <if test="orderColumn != null and orderColumn != ''">
            order by ${orderColumn}
        </if>
        <if test="orderColumn != null and orderColumn != '' and order != 0">
            desc
        </if>
        <if test="orderColumn != null and orderColumn != '' and order == 0">
            asc
        </if>
    </sql>

    <sql id="queryPMSql">
        <if test="shifouchuli != null and shifouchuli != '' ">
            <if test="shifouchuli=='已处理'">
                and chulizhuangtai = '已处理'
            </if>
            <if test="shifouchuli=='未处理'">
                and ifnull(chulizhuangtai,'') = '未处理'
            </if>
        </if>

        <if test="shifoushenshu != null and shifoushenshu != '' ">
            <if test="shifoushenshu=='已申诉'">
                and shensuzhuangtai = '已申诉'
            </if>
            <if test="shifoushenshu=='未申诉'">
                and ifnull(shensuzhuangtai,'') = '未申诉'
            </if>
        </if>

        <if test="cheliangpaizhao != null and cheliangpaizhao != ''">
            and cheliangpaizhao = #{cheliangpaizhao}
        </if>

        <if test="shiyongxingzhi != null and shiyongxingzhi != ''">
            and shiyongxingzhi like '%${shiyongxingzhi}%'
        </if>

        <if test="deptName != null and deptName != ''">
            and company like '%${deptName}%'
        </if>

    </sql>

    <select timeout="600" id="selectBJPMTJ" resultMap="ResultMap"
            parameterType="org.springblade.anbiao.qiyeshouye.page.QiYeTongJiPage">
        <if test="size == 0">
            select * from (
            <include refid="tablePMSql"/>
            )b
            where 1=1
            <include refid="queryPMSql"/>
            <include refid="orderPMSql"/>
            limit ${total}
        </if>
        <if test="current != 0">
            select * from (
            <include refid="tablePMSql"/>
            )b
            where 1=1
            <include refid="queryPMSql"/>
            <include refid="orderPMSql"/>
            limit ${offsetNo},${size}
        </if>
    </select>

    <select timeout="90" id="selectBJTJPMTotal"
            parameterType="org.springblade.anbiao.qiyeshouye.page.QiYeTongJiPage"
            resultType="int">
        select COUNT(1) from (
        <include refid="tablePMSql"/>
        )d where 1 = 1
        <include refid="queryPMSql"/>
    </select>


    <!-- 查询报警统计汇总列表 -->
    <sql id="tableRYXSql">
        <!--select
            a.cid as deptId,
            a.company,
            concat(#{beginTime},'至',#{endTime}) as date,
            a.vehicleCount,
            a.onlineCount,
            a.stopCount,
            a.offlineCount,
            case when IFNULL(a.onlineRate,0) = 0 then '0.00%'
                else concat(ROUND(a.onlineRate*100,2),'%')
            end as onlineRate,
            a.locateCount,
            case when IFNULL(a.locateRate,0) = 0 then '0.00%'
                else concat(ROUND(a.locateRate*100,2),'%')
            end as locateRate,
            case when IFNULL(b.DriftPositionRate,0) = 0 then '0.00%'
                else concat(ROUND(b.DriftPositionRate*10,2),'%')
            end as DriftPositionRate,
            case when IFNULL(b.IntactPositionRate,0) = 0 then '0.00%'
                else concat(ROUND(b.IntactPositionRate*10,2),'%')
            end as IntactPositionRate,
            b.QualifiedPositionCount,
            b.PositionCount,
            case when IFNULL(b.PositionCount,0) = 0 or IFNULL(b.QualifiedPositionCount,0) = 0 then '0.00%'
                else concat(ROUND((b.QualifiedPositionCount*1.0/b.PositionCount)*100,2),'%')
            end as QualifiedPositionRate
        from(
            select
                cid,
                company,
                vehicleCount,
                onlineCount,
                stopCount,
                offlineCount,
                onlineRate,
                locateCount,
                locateRate
            from
                baobiao_clientdailyreport
            where 1=1
                and cid = #{deptId}
                and date &gt;= #{beginTime}
                and date &lt;= #{endTime}
            )a
        left join(
            select
                veh.dept_id,
                avg(sta.DriftPositionRate) as DriftPositionRate,
                avg(sta.IntactPositionRate) as IntactPositionRate,
                avg(sta.QualifiedPositionCount) as QualifiedPositionCount,
                avg(sta.PositionCount) as PositionCount
            from(
                select
                    dept_id,id
                from
                    anbiao_vehicle
                where 1=1
                    and is_deleted = 0
                    and dept_id = #{deptId}
                group by dept_id,id
                ) veh
            inner join(
                select
                    vehicleId,
                    sum(DriftPositionRate) as DriftPositionRate,
                    sum(IntactPositionRate) as IntactPositionRate,
                    sum(QualifiedPositionCount) as QualifiedPositionCount,
                    sum(PositionCount) as PositionCount
                from
                    statisticdetail
                where 1=1
                    and date &gt;= #{beginTime}
                    and date &lt;= #{endTime}
                GROUP BY
                    VehicleId
                )sta on sta.vehicleid = veh.id
            where 1=1
            group by veh.dept_id
        )b on a.cid = b.dept_id-->

        select
            cid,
            company,
            date,
            IFNULL(replace(ltrim(replace(vehiclecount,'0',' ')),' ','0'),0) as vehicleCount,
            IFNULL(UpLineCount,0) as onlineCount,
            IFNULL((vehiclecount-UpLineCount),0) as offlineCount,
            case when IFNULL(vehiclecount,0) = 0 or IFNULL(UpLineCount,0) = 0 then '0.00%'
                else concat(ROUND((UpLineCount*1.0/vehiclecount)*100,2),'%')
            end as onlineRate,
            IFNULL(locateVehicleCount,0) as locateCount,
            case when IFNULL(vehiclecount,0) = 0 or IFNULL(locateVehicleCount,0) = 0 then '0.00%'
                else concat(ROUND((locateVehicleCount*1.0/vehiclecount)*100,2),'%')
            end as locaterate,
            case when ifnull(DriftPositionRate,'') = '' then '100.00%'
                else concat(ROUND(DriftPositionRate*100,2),'%')
            end as DriftPositionRate,
            case when ifnull(IntactPositionRate,'') = '' then '100.00%'
                else concat(ROUND(IntactPositionRate,2),'%')
            end as IntactPositionRate,
            case when ifnull(QualifiedPositionRate,'') = '' then '100.00%'
                else concat(ROUND(QualifiedPositionRate,2),'%')
            end as QualifiedPositionRate
        from
            baobiao_alarmdailyreport
        where 1=1
            and date &gt;= CONCAT( #{beginTime},' 00:00:00')
            and date &lt;= CONCAT( #{endTime},' 23:59:59')
            and cid = #{deptId}
    </sql>

    <sql id="orderRYXSql">
        <!-- 默认排序规则 -->
        <if test="orderColumn == null or orderColumn == ''">
            order by date desc
        </if>
        <if test="orderColumn != null and orderColumn != ''">
            order by ${orderColumn}
        </if>
        <if test="orderColumn != null and orderColumn != '' and order != 0">
            desc
        </if>
        <if test="orderColumn != null and orderColumn != '' and order == 0">
            asc
        </if>
    </sql>

    <sql id="queryRYXSql">

    </sql>

    <select timeout="600" id="selectGetRYXBJTJ" resultMap="RYXResultMap"
            parameterType="org.springblade.anbiao.qiyeshouye.page.QiYeTongJiPage">
        <if test="size == 0">
            select * from (
            <include refid="tableRYXSql"/>
            )b
            where 1=1
            <include refid="queryRYXSql"/>
            <include refid="orderRYXSql"/>
            limit ${total}
        </if>
        <if test="current != 0">
            select * from (
            <include refid="tableRYXSql"/>
            )b
            where 1=1
            <include refid="queryRYXSql"/>
            <include refid="orderRYXSql"/>
            limit ${offsetNo},${size}
        </if>
    </select>

    <select timeout="90" id="selectGetRYXBJTJTotal"
            parameterType="org.springblade.anbiao.qiyeshouye.page.QiYeTongJiPage"
            resultType="int">
        select COUNT(1) from (
        <include refid="tableRYXSql"/>
        )d where 1 = 1
        <include refid="queryRYXSql"/>
    </select>


    <!-- 查询报警统计汇总列表 -->
    <sql id="table24HoursOffLineSql">
        select
            c.id as deptId,
            c.dept_name as deptName,
            a.id,
            a.cheliangpaizhao,
            a.chepaiyanse,
            a.shiyongxingzhi as operatType,
            b.lastTime,
            b.lastPosition,
            b.offlinetime,
            b.LatestPositionTime
        from (
            select id,dept_id,cheliangpaizhao,chepaiyanse,shiyongxingzhi from anbiao_vehicle
            where is_deleted = 0
        ) a
        inner join (
            select
                VehicleId,
                LatestPositionTime,
                LatestPosition,
                date,
                case when LatestPositionTime &lt; '2020-01-01' then '-' else date_format(LatestPositionTime, '%Y-%m-%d %H:%i:%s') end as lastTime,
                LatestPosition as lastPosition,
                case when LatestPositionTime &lt; '2020-01-01' then '从未上线'
                else CONCAT(CASE WHEN FLOOR(TIMESTAMPDIFF(SECOND, LatestPositionTime, date)/3600/24) = 0 THEN ''
                ELSE concat(FLOOR(TIMESTAMPDIFF(SECOND, LatestPositionTime, date)/3600/24),'天') END,
                CASE WHEN FLOOR(TIMESTAMPDIFF(SECOND, LatestPositionTime, date)/3600)%24 = 0 THEN ''
                ELSE concat(FLOOR(TIMESTAMPDIFF(SECOND, LatestPositionTime, date)/3600)%24,'小时') END,
                CASE WHEN FLOOR(TIMESTAMPDIFF(SECOND, LatestPositionTime, date)%3600/60) = 0 THEN '0分钟'
                ELSE concat(FLOOR(TIMESTAMPDIFF(SECOND, LatestPositionTime, date)%3600/60),'分钟') END)end as offlinetime,
                case when LatestPositionTime &lt; '2020-01-01' then null
                else TIMESTAMPDIFF(SECOND, LatestPositionTime, date)end as offlinetimes
            from
                statisticdetail
            where 1=1
                and date &gt;= #{beginTime}
                and LatestPositionTime &lt; #{endTime}
            ) b on a.id = b.VehicleId
        inner join (
        select id,dept_name from blade_dept
        where is_deleted = 0
            and id = #{deptId}
        GROUP BY
            id,dept_name
        ) c on a.dept_id= c.id
        where 1=1
    </sql>

    <sql id="order24HoursOffLineSql">
        <!-- 默认排序规则 -->
        <if test="orderColumn == null or orderColumn == ''">
            order by LatestPositionTime desc
        </if>
        <if test="orderColumn != null and orderColumn != ''">
            order by ${orderColumn}
        </if>
        <if test="orderColumn != null and orderColumn != '' and order != 0">
            desc
        </if>
        <if test="orderColumn != null and orderColumn != '' and order == 0">
            asc
        </if>
    </sql>

    <sql id="query24HoursOffLineSql">

        <if test="cheliangpaizhao != null and cheliangpaizhao != ''">
            and cheliangpaizhao = #{cheliangpaizhao}
        </if>

    </sql>

    <select timeout="600" id="selectGet24HoursOffLineTJ" resultMap="OffLineResultMap"
            parameterType="org.springblade.anbiao.qiyeshouye.page.QiYeTongJiPage">
        <if test="size == 0">
            select * from (
            <include refid="table24HoursOffLineSql"/>
            )b
            where 1=1
            <include refid="query24HoursOffLineSql"/>
            <include refid="order24HoursOffLineSql"/>
            limit ${total}
        </if>
        <if test="current != 0">
            select * from (
            <include refid="table24HoursOffLineSql"/>
            )b
            where 1=1
            <include refid="query24HoursOffLineSql"/>
            <include refid="order24HoursOffLineSql"/>
            limit ${offsetNo},${size}
        </if>
    </select>

    <select timeout="90" id="selectGet24HoursOffLineTJTotal"
            parameterType="org.springblade.anbiao.qiyeshouye.page.QiYeTongJiPage"
            resultType="int">
        select COUNT(1) from (
        <include refid="table24HoursOffLineSql"/>
        )d where 1 = 1
        <include refid="query24HoursOffLineSql"/>
    </select>

    <!-- 查询进出区域汇总列表 -->
    <sql id="tableInOutAreaSql">
        SELECT
            mm.name as areaName,
            CASE mm.areaType when 'rect' then '矩形' when 'circle' then '圆形' when 'polygon' then '多边形' ELSE '' end as
            areaType,
            v.cheliangpaizhao,
            v.chepaiyanse,
            v.shiyongxingzhi as operatType,
            d.dept_name AS deptName,
            a.inTime,
            a.outTime,
            a.inOutTimes,
            a.IsAcross,
            a.KeepTime,
            case when (floor(a.KeepTime / 86400)) = 0 and (floor(a.KeepTime / 3600) % 24) = 0 and (floor(a.KeepTime / 60) % 60) = 0 then CONCAT((a.KeepTime % 60) , '秒')
            when (floor(a.KeepTime / 86400)) = 0 and (floor(a.KeepTime / 3600) % 24) = 0 then CONCAT((floor(a.KeepTime / 60) % 60) , '分' , (a.KeepTime % 60) , '秒')
            when (floor(a.KeepTime / 86400)) = 0 then CONCAT((floor(a.KeepTime / 3600) % 24) ,'时' , (floor(a.KeepTime / 60) % 60) , '分' , (a.KeepTime % 60) , '秒')
            ELSE CONCAT((floor(a.KeepTime / 86400)), '天', (floor(a.KeepTime / 3600) % 24) ,'时' , (floor(a.KeepTime / 60) % 60) , '分' , (a.KeepTime % 60) , '秒')
            end as keeptimeShow
        FROM(
            select
                VehicleId,
                Guid,
                MIN(Time) as inTime,
                Max(Time) as outTime,
                MAX(AreaId) as AreaId,
                count(VehicleId) as inOutTimes,
                max(IsAcross) as IsAcross,
                TIMESTAMPDIFF(SECOND, MIN(Time), Max(Time)) as KeepTime
            from
                baobiao_areaalarm
            where 1=1
                and left(Time,10) &gt;= #{beginTime}
                and left(Time,10) &lt;= #{endTime}
            group by
                VehicleId,
                Guid
            ) AS a
        JOIN anbiao_vehicle AS v ON v.id = a.VehicleId and v.is_deleted=0
        JOIN (
            SELECT
                DISTINCT
                xiaji.id,
                xiaji.parent_id,
                xiaji.dept_name,
                xiaji.is_deleted
            FROM
                blade_dept shangji,
                blade_dept xiaji
            WHERE xiaji.tree_code LIKE CONCAT(shangji.tree_code,'%')
                AND xiaji.is_deleted = 0 AND xiaji.extend_type='机构'
                and shangji.id = #{deptId}
            ) AS d ON d.id = v.dept_id
            JOIN maparea as mm on mm.areaid=a.AreaId
        where 1=1
    </sql>

    <sql id="orderInOutAreaSql">
        <!-- 默认排序规则 -->
        <if test="orderColumn == null or orderColumn == ''">
            order by KeepTime desc
        </if>
        <if test="orderColumn != null and orderColumn != ''">
            order by ${orderColumn}
        </if>
        <if test="orderColumn != null and orderColumn != '' and order != 0">
            desc
        </if>
        <if test="orderColumn != null and orderColumn != '' and order == 0">
            asc
        </if>
    </sql>

    <sql id="queryInOutAreaSql">

        <if test="cheliangpaizhao != null and cheliangpaizhao != ''">
            and cheliangpaizhao like '%${cheliangpaizhao}%'
        </if>

        <if test="deptName != null and deptName != '' ">
            and deptName like '%${deptName}%'
        </if>

        <if test="areaName != null and areaName != '' ">
            and areaName like '%${areaName}%'
        </if>

        <if test="keepTime != null and keepTime != '' ">
            and KeepTime/60 &gt;= ${keepTime}
        </if>

    </sql>

    <select timeout="600" id="selectGetInOutAreaTJ" resultMap="InOutAreaResultMap"
            parameterType="org.springblade.anbiao.qiyeshouye.page.QiYeInOutAreaPage">
        <if test="size == 0">
            select * from (
            <include refid="tableInOutAreaSql"/>
            )b
            where 1=1
            <include refid="queryInOutAreaSql"/>
            <include refid="orderInOutAreaSql"/>
            limit ${total}
        </if>
        <if test="current != 0">
            select * from (
            <include refid="tableInOutAreaSql"/>
            )b
            where 1=1
            <include refid="queryInOutAreaSql"/>
            <include refid="orderInOutAreaSql"/>
            limit ${offsetNo},${size}
        </if>
    </select>

    <select timeout="90" id="selectGetInOutAreaTJTotal"
            parameterType="org.springblade.anbiao.qiyeshouye.page.QiYeInOutAreaPage"
            resultType="int">
        select COUNT(1) from (
        <include refid="tableInOutAreaSql"/>
        )d where 1 = 1
        <include refid="queryInOutAreaSql"/>
    </select>

    <!-- 车辆轨迹完整率报表 -->
    <sql id="tableTrajectoryIntegritySql">
        select
            a.cid as deptId,
            a.dept_name as deptName,
            cheliangpaizhao,
            chepaiyanse,
            LEFT(Date,10) as statisticsDate,
            0 as lostCount,
            PositionCount,
            0 lostMileage,
            ROUND(TravelMileage,2) as totalDistance,
            CONCAT(ROUND(IntactPositionRate*100,2),'%') as IntactPositionRate
        from
            statisticcensus a
            inner join  (
            SELECT
            DISTINCT
            xiaji.id,
            xiaji.parent_id,
            xiaji.dept_name,
            xiaji.is_deleted
            FROM
            blade_dept shangji,
            blade_dept xiaji
            WHERE xiaji.tree_code LIKE CONCAT(shangji.tree_code,'%')
            AND xiaji.is_deleted = 0
            AND xiaji.extend_type='机构'
            AND shangji.id = #{deptId}
            ) b on a.cid = b.id
        where a.date &gt;= CONCAT(#{beginTime},' 00:00:00')
          and a.date &lt; CONCAT(#{endTime},' 00:00:00')

    </sql>

    <sql id="orderTrajectoryIntegritySql">
        <!-- 默认排序规则 -->
        <if test="orderColumn == null or orderColumn == ''">
            order by statisticsDate desc
        </if>
        <if test="orderColumn != null and orderColumn != ''">
            order by ${orderColumn}
        </if>
        <if test="orderColumn != null and orderColumn != '' and order != 0">
            desc
        </if>
        <if test="orderColumn != null and orderColumn != '' and order == 0">
            asc
        </if>
    </sql>

    <sql id="queryTrajectoryIntegritySql">

        <if test="cheliangpaizhao != null and cheliangpaizhao != ''">
            and cheliangpaizhao like '%${cheliangpaizhao}%'
        </if>

        <if test="deptName != null and deptName != '' ">
            and deptName like '%${deptName}%'
        </if>

    </sql>

    <select timeout="600" id="selectGetTrajectoryIntegrityTJ" resultMap="statementResultMap"
            parameterType="org.springblade.anbiao.qiyeshouye.page.QiYeInOutAreaPage">
        <if test="size == 0">
            select * from (
            <include refid="tableTrajectoryIntegritySql"/>
            )b
            where 1=1
            <include refid="queryTrajectoryIntegritySql"/>
            <include refid="orderTrajectoryIntegritySql"/>
            limit ${total}
        </if>
        <if test="current != 0">
            select * from (
            <include refid="tableTrajectoryIntegritySql"/>
            )b
            where 1=1
            <include refid="queryTrajectoryIntegritySql"/>
            <include refid="orderTrajectoryIntegritySql"/>
            limit ${offsetNo},${size}
        </if>
    </select>

    <select timeout="90" id="selectGetTrajectoryIntegrityTotal"
            parameterType="org.springblade.anbiao.qiyeshouye.page.QiYeInOutAreaPage"
            resultType="int">
        select COUNT(1) from (
        <include refid="tableTrajectoryIntegritySql"/>
        )d where 1 = 1
        <include refid="queryTrajectoryIntegritySql"/>
    </select>

    <!-- 轨迹漂移报表 -->
    <sql id="tableGuiJiYiChangSql">
        SELECT
            yw.vehid AS vehid,
            yw.cid AS deptid,
            yw.dept_name AS deptName,
            yw.cheliangpaizhao AS cheliangpaizhao,
            yw.chepaiyanse AS chepaiyanse,
            yw.shiyongxingzhi AS shiyongxingzhi,
            DATE_FORMAT(yw.drift_start,'%Y-%m-%d %H:%i:%s') AS startTime,
            DATE_FORMAT(yw.drift_end,'%Y-%m-%d %H:%i:%s') AS endTime,
            DATE_FORMAT(yw.drift_alarm_time,'%Y-%m-%d %H:%i:%s') AS alarmTime,
            yw.drift_long AS driftLong,
            yw.drift_start_location AS startLocation,
            yw.drift_end_location AS endLocatin
        FROM
            xf_report_drift as yw
                inner join  (
                SELECT
                    DISTINCT
                    xiaji.id,
                    xiaji.parent_id,
                    xiaji.dept_name,
                    xiaji.is_deleted
                FROM
                    blade_dept shangji,
                    blade_dept xiaji
                WHERE xiaji.tree_code LIKE CONCAT(shangji.tree_code,'%')
                  AND xiaji.is_deleted = 0
                  AND xiaji.extend_type='机构'
                  AND shangji.id = #{deptId}
                ) b on yw.cid = b.id
        where 1=1
          and yw.drift_alarm_time &gt;= CONCAT(#{beginTime},' 00:00:00')
          and yw.drift_alarm_time &lt; CONCAT(#{endTime},' 00:00:00')
    </sql>

    <sql id="orderGuiJiYiChangSql">
        <!-- 默认排序规则 -->
        <if test="orderColumn == null or orderColumn == ''">
            order by cheliangpaizhao desc
        </if>
        <if test="orderColumn != null and orderColumn != ''">
            order by ${orderColumn}
        </if>
        <if test="orderColumn != null and orderColumn != '' and order != 0">
            desc
        </if>
        <if test="orderColumn != null and orderColumn != '' and order == 0">
            asc
        </if>
    </sql>

    <sql id="queryGuiJiYiChangSql">

        <if test="cheliangpaizhao != null and cheliangpaizhao != ''">
            and cheliangpaizhao like '%${cheliangpaizhao}%'
        </if>

        <if test="deptName != null and deptName != '' ">
            and deptName like '%${deptName}%'
        </if>

    </sql>

    <select timeout="600" id="selectGuiJiYiChangTJ" resultMap="TrajectoryAnomaliesResultMap"
            parameterType="org.springblade.anbiao.qiyeshouye.page.QiYeInOutAreaPage">
        <if test="size == 0">
            select * from (
            <include refid="tableGuiJiYiChangSql"/>
            )b
            where 1=1
            <include refid="queryGuiJiYiChangSql"/>
            <include refid="orderGuiJiYiChangSql"/>
            limit ${total}
        </if>
        <if test="current != 0">
            select * from (
            <include refid="tableGuiJiYiChangSql"/>
            )b
            where 1=1
            <include refid="queryGuiJiYiChangSql"/>
            <include refid="orderGuiJiYiChangSql"/>
            limit ${offsetNo},${size}
        </if>
    </select>

    <select timeout="90" id="selectGuiJiYiChangTotal"
            parameterType="org.springblade.anbiao.qiyeshouye.page.QiYeInOutAreaPage"
            resultType="int">
        select COUNT(1) from (
        <include refid="tableGuiJiYiChangSql"/>
        )d where 1 = 1
        <include refid="queryGuiJiYiChangSql"/>
    </select>

    <!-- 停车明细报表 -->
    <sql id="tableTingCheMingXiSql">
        SELECT
            yw.vehid AS vehid,
            yw.cid AS deptid,
            yw.dept_name AS deptName,
            yw.cheliangpaizhao AS cheliangpaizhao,
            yw.chepaiyanse AS chepaiyanse,
            yw.shiyongxingzhi AS shiyongxingzhi,
            DATE_FORMAT(yw.drift_start,'%Y-%m-%d %H:%i:%s') AS startTime,
            DATE_FORMAT(yw.drift_end,'%Y-%m-%d %H:%i:%s') AS endTime,
            DATE_FORMAT(yw.drift_alarm_time,'%Y-%m-%d %H:%i:%s') AS alarmTime,
            yw.drift_long AS driftLong,
            yw.drift_start_location AS startLocation,
            yw.drift_end_location AS endLocatin
        FROM
            xf_report_drift as yw
                inner join  (
                SELECT
                    DISTINCT
                    xiaji.id,
                    xiaji.parent_id,
                    xiaji.dept_name,
                    xiaji.is_deleted
                FROM
                    blade_dept shangji,
                    blade_dept xiaji
                WHERE xiaji.tree_code LIKE CONCAT(shangji.tree_code,'%')
                  AND xiaji.is_deleted = 0
                  AND xiaji.extend_type='机构'
                  AND shangji.id = #{deptId}
                ) b on yw.cid = b.id
        where 1=1
          and yw.drift_start &gt;= CONCAT(#{beginTime},' 00:00:00')
          and yw.drift_start &lt; CONCAT(#{endTime},' 00:00:00')
    </sql>

    <sql id="orderTingCheMingXiSql">
        <!-- 默认排序规则 -->
        <if test="orderColumn == null or orderColumn == ''">
            order by cheliangpaizhao desc
        </if>
        <if test="orderColumn != null and orderColumn != ''">
            order by ${orderColumn}
        </if>
        <if test="orderColumn != null and orderColumn != '' and order != 0">
            desc
        </if>
        <if test="orderColumn != null and orderColumn != '' and order == 0">
            asc
        </if>
    </sql>

    <sql id="queryTingCheMingXiSql">

        <if test="cheliangpaizhao != null and cheliangpaizhao != ''">
            and cheliangpaizhao like '%${cheliangpaizhao}%'
        </if>

        <if test="deptName != null and deptName != '' ">
            and deptName like '%${deptName}%'
        </if>

    </sql>

    <select timeout="600" id="selectTingCheMingXiTJ" resultMap="StopVehicleResultMap"
            parameterType="org.springblade.anbiao.qiyeshouye.page.QiYeInOutAreaPage">
        <if test="size == 0">
            select * from (
            <include refid="tableTingCheMingXiSql"/>
            )b
            where 1=1
            <include refid="queryTingCheMingXiSql"/>
            <include refid="orderTingCheMingXiSql"/>
            limit ${total}
        </if>
        <if test="current != 0">
            select * from (
            <include refid="tableTingCheMingXiSql"/>
            )b
            where 1=1
            <include refid="queryTingCheMingXiSql"/>
            <include refid="orderTingCheMingXiSql"/>
            limit ${offsetNo},${size}
        </if>
    </select>

    <select timeout="90" id="selectTingCheMingXiTotal"
            parameterType="org.springblade.anbiao.qiyeshouye.page.QiYeInOutAreaPage"
            resultType="int">
        select COUNT(1) from (
        <include refid="tableTingCheMingXiSql"/>
        )d where 1 = 1
        <include refid="queryTingCheMingXiSql"/>
    </select>

    <!-- 停车汇总报表 -->
    <sql id="tableTingCheHuiZongSql">
        select
            vehId,deptId,deptName,cheliangpaizhao,chepaiyanse,shiyongxingzhi,stopTimes,stopAccOnTimes,
            case
                when (floor(stopLong / 86400)) = 0 and (floor(stopLong / 3600) % 24) = 0 and (floor(stopLong / 60) % 60) = 0 then CONCAT((stopLong % 60) , '秒')
                when (floor(stopLong / 86400)) = 0 and (floor(stopLong / 3600) % 24) = 0 then CONCAT((floor(stopLong / 60) % 60) , '分' , (stopLong % 60) , '秒')
                when (floor(stopLong / 86400)) = 0 then CONCAT((floor(stopLong / 3600) % 24) ,'时' , (floor(stopLong / 60) % 60) , '分' , (stopLong % 60) , '秒')
                ELSE CONCAT((floor(stopLong / 86400)), '天', (floor(stopLong / 3600) % 24) ,'时' , (floor(stopLong / 60) % 60) , '分' , (stopLong % 60) , '秒')
                end as stopLong,
            case
                when (floor(stopAccOnLong / 86400)) = 0 and (floor(stopAccOnLong / 3600) % 24) = 0 and (floor(stopAccOnLong / 60) % 60) = 0 then CONCAT((stopAccOnLong % 60) , '秒')
                when (floor(stopAccOnLong / 86400)) = 0 and (floor(stopAccOnLong / 3600) % 24) = 0 then CONCAT((floor(stopAccOnLong / 60) % 60) , '分' , (stopAccOnLong % 60) , '秒')
                when (floor(stopAccOnLong / 86400)) = 0 then CONCAT((floor(stopAccOnLong / 3600) % 24) ,'时' , (floor(stopAccOnLong / 60) % 60) , '分' , (stopAccOnLong % 60) , '秒')
                ELSE CONCAT((floor(stopAccOnLong / 86400)), '天', (floor(stopAccOnLong / 3600) % 24) ,'时' , (floor(stopAccOnLong / 60) % 60) , '分' , (stopAccOnLong % 60) , '秒')
                end as stopAccOnLong,
            #{beginTime} as startTime,
            #{endTime} as endTime
        from(
                SELECT
                    yw.vehid AS vehId,
                    max(yw.cid) AS deptId,
                    max(yw.dept_name) AS deptName,
                    max(yw.cheliangpaizhao) AS cheliangpaizhao,
                    max(yw.chepaiyanse) AS chepaiyanse,
                    max(yw.shiyongxingzhi) AS shiyongxingzhi,
                    count(case yw.stop_type WHEN 1 THEN yw.id ELSE 0 end) as stopTimes,
                    count(case yw.stop_type WHEN 2 THEN yw.id ELSE 0 end) as stopAccOnTimes,
                    sum(case yw.stop_type WHEN 1 THEN yw.stop_long ELSE 0 end) as stopLong,
                    sum(case yw.stop_type WHEN 2 THEN yw.stop_long ELSE 0 end) as stopAccOnLong
                FROM
                    xf_report_stop as yw
                        inner join  (
                        SELECT
                            DISTINCT
                            xiaji.id,
                            xiaji.parent_id,
                            xiaji.dept_name,
                            xiaji.is_deleted
                        FROM
                            blade_dept shangji,
                            blade_dept xiaji
                        WHERE xiaji.tree_code LIKE CONCAT(shangji.tree_code,'%')
                          AND xiaji.is_deleted = 0
                          AND xiaji.extend_type='机构'
                          AND shangji.id = #{deptId}
                        ) b on yw.cid = b.id
                where 1=1
                  and yw.stop_start &gt;= CONCAT(#{beginTime},' 00:00:00')
                  and yw.stop_start &lt; CONCAT(#{endTime},' 00:00:00')
                  and yw.stop_long &gt; 0
                group by
                    yw.vehid
                )a
    </sql>

    <sql id="orderTingCheHuiZongSql">
        <!-- 默认排序规则 -->
        <if test="orderColumn == null or orderColumn == ''">
            order by cheliangpaizhao desc
        </if>
        <if test="orderColumn != null and orderColumn != ''">
            order by ${orderColumn}
        </if>
        <if test="orderColumn != null and orderColumn != '' and order != 0">
            desc
        </if>
        <if test="orderColumn != null and orderColumn != '' and order == 0">
            asc
        </if>
    </sql>

    <sql id="queryTingCheHuiZongSql">

        <if test="cheliangpaizhao != null and cheliangpaizhao != ''">
            and cheliangpaizhao like '%${cheliangpaizhao}%'
        </if>

        <if test="deptName != null and deptName != '' ">
            and deptName like '%${deptName}%'
        </if>

    </sql>

    <select timeout="600" id="selectTingCheHuiZongTJ" resultMap="StopVehicleResultMap"
            parameterType="org.springblade.anbiao.qiyeshouye.page.QiYeInOutAreaPage">
        <if test="size == 0">
            select * from (
            <include refid="tableTingCheHuiZongSql"/>
            )b
            where 1=1
            <include refid="queryTingCheHuiZongSql"/>
            <include refid="orderTingCheHuiZongSql"/>
            limit ${total}
        </if>
        <if test="current != 0">
            select * from (
            <include refid="tableTingCheHuiZongSql"/>
            )b
            where 1=1
            <include refid="queryTingCheHuiZongSql"/>
            <include refid="orderTingCheMingXiSql"/>
            limit ${offsetNo},${size}
        </if>
    </select>

    <select timeout="90" id="selectTingCheHuiZongTotal"
            parameterType="org.springblade.anbiao.qiyeshouye.page.QiYeInOutAreaPage"
            resultType="int">
        select COUNT(1) from (
        <include refid="tableTingCheHuiZongSql"/>
        )d where 1 = 1
        <include refid="queryTingCheHuiZongSql"/>
    </select>

    <!-- 查询企业在线车辆详情列表 -->
    <sql id="tabletpvehdataSql">
        select
            b.dept_name as DeptName,
            a.*
        from
            tpvehdata a
        inner join(
            <include refid="org.springblade.anbiao.guanlijigouherenyuan.mapper.OrganizationsMapper.getByDeptId"/>
            )b on a.DeptID = b.id
        where 1=1
            and Systime &gt;= CONCAT( #{beginTime},' 00:00:00')
            and Systime &lt;= CONCAT( #{endTime},' 23:59:59')
    </sql>

    <sql id="ordertpvehdataSql">
        <!-- 默认排序规则 -->
        <if test="orderColumn == null or orderColumn == ''">
            order by Systime desc
        </if>
        <if test="orderColumn != null and orderColumn != ''">
            order by ${orderColumn}
        </if>
        <if test="orderColumn != null and orderColumn != '' and order != 0">
            desc
        </if>
        <if test="orderColumn != null and orderColumn != '' and order == 0">
            asc
        </if>
    </sql>

    <sql id="querytpvehdataSql">

        <if test="cheliangpaizhao != null and cheliangpaizhao != ''">
            and VeNumber like '%${cheliangpaizhao}%'
        </if>

        <if test=" alarmShow == '报警' ">
            and ifnull(Alarm,0) = 1
        </if>

        <if test=" alarmShow == '未报警' ">
            and ifnull(Alarm,0) = 0
        </if>

        <if test=" locateShow == '定位' ">
            and ifnull(Locate,0) = 1
        </if>

        <if test=" locateShow == '不定位' ">
            and ifnull(Locate,0) = 0
        </if>

    </sql>

    <select timeout="600" id="selecttpvehdataTJ" resultMap="TpvehdataResultMap"
            parameterType="org.springblade.anbiao.qiyeshouye.page.QiYeTpvehdataPage">
        <if test="size == 0">
            select * from (
            <include refid="tabletpvehdataSql"/>
            )b
            where 1=1
            <include refid="querytpvehdataSql"/>
            <include refid="ordertpvehdataSql"/>
            limit ${total}
        </if>
        <if test="current != 0">
            select * from (
            <include refid="tabletpvehdataSql"/>
            )b
            where 1=1
            <include refid="querytpvehdataSql"/>
            <include refid="ordertpvehdataSql"/>
            limit ${offsetNo},${size}
        </if>
    </select>

    <select timeout="90" id="selectGettpvehdataTJTotal"
            parameterType="org.springblade.anbiao.qiyeshouye.page.QiYeTpvehdataPage"
            resultType="int">
        select COUNT(1) from (
        <include refid="tabletpvehdataSql"/>
        )d where 1 = 1
        <include refid="querytpvehdataSql"/>
    </select>

    <resultMap id="QiYeDriverAlarmTongJiResultMap" type="org.springblade.anbiao.qiyeshouye.entity.QiYeDriverAlarmTongJi">
    </resultMap>

    <!-- 查询企业驾驶员违规统计列表 -->
    <sql id="tabletDriverAlarmSql">
        select
            *
        from(
            select
                a.id as deptId,
                a.dept_name as deptName,
                b.id,
                b.jiashiyuanxingming,
                b.shoujihaoma,
                b.shenfenzhenghao,
                b.congyezigezheng,
                COUNT(d.AlarmReportID)+COUNT(e.id) as alarmnum,
                case when IFNULL(max(study_driver_id),'') = '' then '否' else '是' end as studystatus,
                case
                    when IFNULL(max(c.status),0) = 0  and IFNULL(max(study_driver_id),'') != ''  then '未学习'
                    when IFNULL(max(c.status),0) = 1 and IFNULL(max(study_driver_id),'') != ''  then '学习中'
                    when IFNULL(max(c.status),0) = 2  and IFNULL(max(study_driver_id),'') != ''  then '已学完'
                    else ''
                end as studyremark
            from
                blade_dept a
            inner join anbiao_jiashiyuan b on a.id = b.dept_id
            inner join baobiao_alarmhandleresult_driver c on b.id = c.driver_id
            left join(
                select AlarmType,AlarmReportID,CutoffTime from baobiao_alarmsummary_cutofftime
                where CutoffTime >= CONCAT( #{beginTime},' 00:00:00')
                    and CutoffTime &lt;= CONCAT( #{endTime},' 23:59:59')
                    and Passed = 100
                    and AnalyzeMode = 1
                ) d on c.alarm_id = d.AlarmReportID and (c.alarm_type = d.AlarmType or d.AlarmType = '异常车辆报警')
            left join(
                select AlarmType,id,GpsTime from baobiao_driverbehavior
                where GpsTime >= CONCAT( #{beginTime},' 00:00:00')
                    and GpsTime &lt;= CONCAT( #{endTime},' 23:59:59')
                    and StateEx = '核定报警'
                    and cid = #{deptId}
                ) e on e.id = c.alarm_id and c.alarm_type = e.AlarmType
            where 1=1
                and a.id = #{deptId}
            GROUP BY
                a.id,
                a.dept_name,
                b.id,
                b.jiashiyuanxingming,
                b.shenfenzhenghao,
                b.congyezigezheng,
                b.shoujihaoma
            )a where 1=1
    </sql>

    <sql id="ordertDriverAlarmSql">
        <!-- 默认排序规则 -->
        <if test="orderColumn == null or orderColumn == ''">
            order by alarmnum desc
        </if>
        <if test="orderColumn != null and orderColumn != ''">
            order by ${orderColumn}
        </if>
        <if test="orderColumn != null and orderColumn != '' and order != 0">
            desc
        </if>
        <if test="orderColumn != null and orderColumn != '' and order == 0">
            asc
        </if>
    </sql>

    <sql id="queryDriverAlarmSql">

        <if test="jiashiyuanxingming != null and jiashiyuanxingming != ''">
            and jiashiyuanxingming like '%${jiashiyuanxingming}%'
        </if>

        <if test="plateNumber != null and plateNumber != ''">
            and plateNumber like '%${plateNumber}%'
        </if>

        <if test="color != null and color != ''">
            and color = #{color}
        </if>

        <if test="alarmType != null and alarmType != ''">
            and alarmType = #{alarmType}
        </if>

        <if test="congyezigezheng != null and congyezigezheng != ''">
            and congyezigezheng = #{congyezigezheng}
        </if>

        <if test="shenfenzhenghao != null and shenfenzhenghao != ''">
            and shenfenzhenghao = #{shenfenzhenghao}
        </if>

    </sql>

    <select timeout="600" id="seleDriverAlarmTJ" resultMap="QiYeDriverAlarmTongJiResultMap"
            parameterType="org.springblade.anbiao.qiyeshouye.page.QiYeDriverAlarmTongJiPage">
        <if test="size == 0">
            select * from (
            <include refid="tabletDriverAlarmSql"/>
            )b
            where 1=1
            <include refid="queryDriverAlarmSql"/>
            <include refid="ordertDriverAlarmSql"/>
            limit ${total}
        </if>
        <if test="current != 0">
            select * from (
            <include refid="tabletDriverAlarmSql"/>
            )b
            where 1=1
            <include refid="queryDriverAlarmSql"/>
            <include refid="ordertDriverAlarmSql"/>
            limit ${offsetNo},${size}
        </if>
    </select>

    <select timeout="90" id="selectDriverAlarmTJTotal"
            parameterType="org.springblade.anbiao.qiyeshouye.page.QiYeDriverAlarmTongJiPage"
            resultType="int">
        select COUNT(1) from (
        <include refid="tabletDriverAlarmSql"/>
        )d where 1 = 1
        <include refid="queryDriverAlarmSql"/>
    </select>

    <!-- 查询企业驾驶员违规统计详情列表 -->
    <sql id="tabletDriverAlarmXQSql">
        select * from(
            select
                a.id as deptId,
                a.dept_name as deptName,
                b.jiashiyuanxingming,
                b.shoujihaoma,
                b.congyezigezheng,
                b.shenfenzhenghao,
                d.*
            from
                blade_dept a
            inner join anbiao_jiashiyuan b on a.id = b.dept_id
            inner join baobiao_alarmhandleresult_driver c on b.id = c.driver_id
            inner join(
                select
                    AlarmReportID as alarmId,plateNumber as plate,color,AlarmType,beginTime,endTime,Velocity as velocity,latitude as lat,longitude as lon,Road_Name as roadname,
                    b.chulizhuangtai,
                    b.chulixingshi,
                    b.chulimiaoshu,
                    b.chulirenid,
                    b.chuliren,
                    b.chulishijian,
                    b.fujian,
                    b.beizhu,
                    b.remark,
                    b.shensushenhebiaoshi,
                    b.shensushenheren,
                    b.shensushenheshijian,
                    b.shensushenheyijian,
                    b.twicechulixingshi,
                    b.twicechulimiaoshu,
                    b.twicefujian,
                    b.twicechuliren,
                    b.twicechulishijian,
                    b.twicechulirenid,
                    b.endresult
                from
                    baobiao_alarmsummary_cutofftime a
                left join (select id,dept_id from anbiao_vehicle) v on a.VehId = v.id
                left JOIN baobiao_alarmhandleresult AS b ON a.AlarmReportID = b.baojingid
                    and v.dept_id = b.qiyeid
                    and (a.AlarmType=b.baojingleixing or b.baojingleixing = '异常车辆报警')
                    and ifnull(b.is_deleted,0) = 0
                where CutoffTime >= CONCAT( #{beginTime},' 00:00:00')
                    and CutoffTime &lt;= CONCAT( #{endTime},' 23:59:59')
                    and Passed = 100
                    and AnalyzeMode = 1
                ) d on c.alarm_id = d.alarmId and (c.alarm_type = d.AlarmType or d.AlarmType = '异常车辆报警')
            where a.id = #{deptId}
                and b.id = #{driverId}
            UNION ALL
            select
                a.id as deptId,
                a.dept_name as deptName,
                b.jiashiyuanxingming,
                b.shoujihaoma,
                b.congyezigezheng,
                b.shenfenzhenghao,
                e.*
            from
                blade_dept a
            inner join anbiao_jiashiyuan b on a.id = b.dept_id
            inner join baobiao_alarmhandleresult_driver c on b.id = c.driver_id
            inner join(
                select
                    a.id as alarmId,plate,color,AlarmType,GpsTime as beginTime,GpsTime as endTime,Velocity as velocity,lat,lon,'' as roadname,
                    b.chulizhuangtai,
                    b.chulixingshi,
                    b.chulimiaoshu,
                    b.chulirenid,
                    b.chuliren,
                    b.chulishijian,
                    b.fujian,
                    b.beizhu,
                    b.remark,
                    b.shensushenhebiaoshi,
                    b.shensushenheren,
                    b.shensushenheshijian,
                    b.shensushenheyijian,
                    b.twicechulixingshi,
                    b.twicechulimiaoshu,
                    b.twicefujian,
                    b.twicechuliren,
                    b.twicechulishijian,
                    b.twicechulirenid,
                    b.endresult
                from
                    baobiao_driverbehavior a
                left join baobiao_alarmhandleresult b on a.id = b.baojingid and a.AlarmType=b.baojingleixing
                where GpsTime >= CONCAT( #{beginTime},' 00:00:00')
                    and GpsTime &lt;= CONCAT( #{endTime},' 23:59:59')
                    and StateEx = '核定报警'
                    and cid = #{deptId}
                ) e on e.alarmId = c.alarm_id and c.alarm_type = e.AlarmType
            where a.id = #{deptId}
                and b.id = #{driverId}
            )a
    </sql>

    <sql id="ordertDriverAlarmXQSql">
        <!-- 默认排序规则 -->
        <if test="orderColumn == null or orderColumn == ''">
            order by beginTime desc
        </if>
        <if test="orderColumn != null and orderColumn != ''">
            order by ${orderColumn}
        </if>
        <if test="orderColumn != null and orderColumn != '' and order != 0">
            desc
        </if>
        <if test="orderColumn != null and orderColumn != '' and order == 0">
            asc
        </if>
    </sql>

    <select timeout="600" id="seleDriverAlarmXQTJ" resultMap="QiYeDriverAlarmTongJiResultMap"
            parameterType="org.springblade.anbiao.qiyeshouye.page.QiYeDriverAlarmTongJiPage">
        <if test="size == 0">
            select * from (
            <include refid="tabletDriverAlarmXQSql"/>
            )b
            where 1=1
            <include refid="queryDriverAlarmSql"/>
            <include refid="ordertDriverAlarmXQSql"/>
            limit ${total}
        </if>
        <if test="current != 0">
            select * from (
            <include refid="tabletDriverAlarmXQSql"/>
            )b
            where 1=1
            <include refid="queryDriverAlarmSql"/>
            <include refid="ordertDriverAlarmXQSql"/>
            limit ${offsetNo},${size}
        </if>
    </select>

    <select timeout="90" id="selectDriverAlarmTJXQTotal"
            parameterType="org.springblade.anbiao.qiyeshouye.page.QiYeDriverAlarmTongJiPage"
            resultType="int">
        select COUNT(1) from (
        <include refid="tabletDriverAlarmXQSql"/>
        )d where 1 = 1
        <include refid="queryDriverAlarmSql"/>
    </select>

    <resultMap id="QiYeTTSTongJiResultMap" type="org.springblade.anbiao.qiyeshouye.entity.QiYeTTSTongJi">
    </resultMap>

    <!-- 查询企业tts日志列表 -->
    <sql id="tabletTTSSql">
        select
            q.id as deptId,
            q.dept_name as deptName,
            a.id as vehId,
            a.cheliangpaizhao,
            a.chepaiyanse,
            a.shiyongxingzhi,
            a.xinghao,
            a.zongduanid,
            '车载终端' as zhongduanleixing,
            a.zongduanxinghao,
            b.time,
            b.message,
            b.sendState,
            b.source,
            b.gpstime,
            b.alarmType,
            b.messageType,
            b.sendPort,
            b.sendType,
            b.AlarmGuid,
            b.LastSpeed as lastSpeed,
            'admin' as sendperson
        from
            blade_dept q
        LEFT JOIN(
            select
                id,cheliangpaizhao,chepaiyanse,shiyongxingzhi,xinghao,dept_id,zongduanid,zongduanxinghao
            from
                anbiao_vehicle
            where is_deleted = 0
            )a on q.id= a.dept_id
        INNER JOIN(
            select * from tts_message
        where gpstime &gt;= CONCAT( left(#{beginTime},10), ' 00:00:00')
            and gpstime &lt;= CONCAT( left(#{endTime},10), ' 23:59:59')
        )b on a.id = b.vehId
        where 1=1
            and q.id = #{deptId}
        <if test="messageType != null and messageType != ''">
            and messageType = #{messageType}
        </if>
        <if test="alarmType != null and alarmType != ''">
            and AlarmType like '%${alarmType}%'
        </if>
        <if test="shiyongxingzhi != null and shiyongxingzhi != ''">
            and shiyongxingzhi = #{shiyongxingzhi}
        </if>
        <if test="cheliangpaizhao != null and cheliangpaizhao != ''">
            and a.cheliangpaizhao like '%${cheliangpaizhao}%'
        </if>
    </sql>

    <sql id="queryTTSSql">

    </sql>

    <sql id="ordertTTSSql">
        <!-- 默认排序规则 -->
        <if test="orderColumn == null or orderColumn == ''">
            order by gpstime desc
        </if>
        <if test="orderColumn != null and orderColumn != ''">
            order by ${orderColumn}
        </if>
        <if test="orderColumn != null and orderColumn != '' and order != 0">
            desc
        </if>
        <if test="orderColumn != null and orderColumn != '' and order == 0">
            asc
        </if>
    </sql>

    <select timeout="600" id="selectTTSTJ" resultMap="QiYeTTSTongJiResultMap"
            parameterType="org.springblade.anbiao.qiyeshouye.page.QiYeTTSTongJiPage">
        <if test="size == 0">
            select * from (
            <include refid="tabletTTSSql"/>
            )b
            where 1=1
            <include refid="queryTTSSql"/>
            <include refid="ordertTTSSql"/>
            limit ${total}
        </if>
        <if test="current != 0">
            select * from (
            <include refid="tabletTTSSql"/>
            )b
            where 1=1
            <include refid="queryTTSSql"/>
            <include refid="ordertTTSSql"/>
            limit ${offsetNo},${size}
        </if>
    </select>

    <select timeout="90" id="selectTTSTotal"
            parameterType="org.springblade.anbiao.qiyeshouye.page.QiYeTTSTongJiPage"
            resultType="int">
        select COUNT(1) from (
        <include refid="tabletTTSSql"/>
        )d where 1 = 1
        <include refid="queryTTSSql"/>
    </select>

    <resultMap id="QiYeMileageTongJiResultMap" type="org.springblade.anbiao.qiyeshouye.entity.QiYeMileageTongJi">
    </resultMap>

    <!-- 查询里程统计报表 -->
    <sql id="tabletMileageSql">
        select
            vehicleId as vehId,cid as deptId,dept_name as deptName,cheliangpaizhao,chepaiyanse,
            shiyongxingzhi,LEFT(Date,10) as statisticsDate,ROUND(TravelMileage,2) as TravelMileage,
            case
                when (floor(TravelTimes / 86400)) = 0 and (floor(TravelTimes / 3600) % 24) = 0 and (floor(TravelTimes / 60) % 60) = 0 then CONCAT((TravelTimes % 60) , '秒')
                when (floor(TravelTimes / 86400)) = 0 and (floor(TravelTimes / 3600) % 24) = 0 then CONCAT((floor(TravelTimes / 60) % 60) , '分' , (TravelTimes % 60) , '秒')
                when (floor(TravelTimes / 86400)) = 0 then CONCAT((floor(TravelTimes / 3600) % 24) ,'时' , (floor(TravelTimes / 60) % 60) , '分' , (TravelTimes % 60) , '秒')
                ELSE CONCAT((floor(TravelTimes / 86400)), '天', (floor(TravelTimes / 3600) % 24) ,'时' , (floor(TravelTimes / 60) % 60) , '分' , (TravelTimes % 60) , '秒')
            end as TravelTimes,
            '' as travelStartMileage,'' as travelStopMileage,
            ROUND(TravelMileage*1.0/TravelTimes*60*60,2) as averageSpeed,
            TravelStartPosition,TravelStopPosition
        from
            statisticcensus
        where date &gt;= CONCAT( #{beginTime}, ' 00:00:00')
          and date &lt;= CONCAT( #{endTime}, ' 23:59:59')
          and cid = #{deptId}
        <if test="cheliangpaizhao != null and cheliangpaizhao != ''">
          and cheliangpaizhao like '%${cheliangpaizhao}%'
        </if>
    </sql>

    <sql id="queryMileageSql">
    </sql>

    <sql id="ordertMileageSql">
        <!-- 默认排序规则 -->
        <if test="orderColumn == null or orderColumn == ''">
            order by TravelMileage desc
        </if>
        <if test="orderColumn != null and orderColumn != ''">
            order by ${orderColumn}
        </if>
        <if test="orderColumn != null and orderColumn != '' and order != 0">
            desc
        </if>
        <if test="orderColumn != null and orderColumn != '' and order == 0">
            asc
        </if>
    </sql>

    <select timeout="600" id="selectMileageTJ" resultMap="QiYeMileageTongJiResultMap"
            parameterType="org.springblade.anbiao.qiyeshouye.page.QiYeTTSTongJiPage">
        <if test="size == 0">
            select * from (
            <include refid="tabletMileageSql"/>
            )b
            where 1=1
            <include refid="queryMileageSql"/>
            <include refid="ordertMileageSql"/>
            limit ${total}
        </if>
        <if test="current != 0">
            select * from (
            <include refid="tabletMileageSql"/>
            )b
            where 1=1
            <include refid="queryMileageSql"/>
            <include refid="ordertMileageSql"/>
            limit ${offsetNo},${size}
        </if>
    </select>

    <select timeout="90" id="selectMileageTotal"
            parameterType="org.springblade.anbiao.qiyeshouye.page.QiYeTTSTongJiPage"
            resultType="int">
        select COUNT(1) from (
        <include refid="tabletMileageSql"/>
        )d where 1 = 1
        <include refid="queryMileageSql"/>
    </select>

    <resultMap id="QiYeMonthMileageTongJiResultMap" type="org.springblade.anbiao.qiyeshouye.entity.QiYeMonthMileageTongJi">
    </resultMap>

    <!-- 企业车辆里程统计表查询 -->
    <sql id="tabletMonthMileageSql">
        select
            cheliangpaizhao,
            chepaiyanse,
            LEFT(#{date},7) as date,
            SUM(ROUND(TravelMileage,2)) as TravelMileage,
            SUM(ROUND(CASE day(date) WHEN '1' THEN TravelMileage ELSE 0 END ,2)) one,
            SUM(ROUND(CASE day(date) WHEN '2' THEN TravelMileage ELSE 0 END ,2)) two,
            SUM(ROUND(CASE day(date) WHEN '3' THEN TravelMileage ELSE 0 END ,2)) three,
            SUM(ROUND(CASE day(date) WHEN '4' THEN TravelMileage ELSE 0 END ,2)) four,
            SUM(ROUND(CASE day(date) WHEN '5' THEN TravelMileage ELSE 0 END ,2)) five,
            SUM(ROUND(CASE day(date) WHEN '6' THEN TravelMileage ELSE 0 END ,2)) six,
            SUM(ROUND(CASE day(date) WHEN '7' THEN TravelMileage ELSE 0 END ,2)) seven,
            SUM(ROUND(CASE day(date) WHEN '8' THEN TravelMileage ELSE 0 END ,2)) eight,
            SUM(ROUND(CASE day(date) WHEN '9' THEN TravelMileage ELSE 0 END ,2)) nine,
            SUM(ROUND(CASE day(date) WHEN '10' THEN TravelMileage ELSE 0 END ,2)) ten,
            SUM(ROUND(CASE day(date) WHEN '11' THEN TravelMileage ELSE 0 END ,2)) eleven,
            SUM(ROUND(CASE day(date) WHEN '12' THEN TravelMileage ELSE 0 END ,2)) twelve,
            SUM(ROUND(CASE day(date) WHEN '13' THEN TravelMileage ELSE 0 END ,2)) thirteen,
            SUM(ROUND(CASE day(date) WHEN '14' THEN TravelMileage ELSE 0 END ,2)) fourteen,
            SUM(ROUND(CASE day(date) WHEN '15' THEN TravelMileage ELSE 0 END ,2)) fifteen,
            SUM(ROUND(CASE day(date) WHEN '16' THEN TravelMileage ELSE 0 END ,2)) sixteen,
            SUM(ROUND(CASE day(date) WHEN '17' THEN TravelMileage ELSE 0 END ,2)) seventeen,
            SUM(ROUND(CASE day(date) WHEN '18' THEN TravelMileage ELSE 0 END ,2)) eighteen,
            SUM(ROUND(CASE day(date) WHEN '19' THEN TravelMileage ELSE 0 END ,2)) nineteen,
            SUM(ROUND(CASE day(date) WHEN '20' THEN TravelMileage ELSE 0 END ,2)) twenty,
            SUM(ROUND(CASE day(date) WHEN '21' THEN TravelMileage ELSE 0 END ,2)) twentyone,
            SUM(ROUND(CASE day(date) WHEN '22' THEN TravelMileage ELSE 0 END ,2)) twentytwo,
            SUM(ROUND(CASE day(date) WHEN '23' THEN TravelMileage ELSE 0 END ,2)) twentythree,
            SUM(ROUND(CASE day(date) WHEN '24' THEN TravelMileage ELSE 0 END ,2)) twentyfour,
            SUM(ROUND(CASE day(date) WHEN '25' THEN TravelMileage ELSE 0 END ,2)) twentyfive,
            SUM(ROUND(CASE day(date) WHEN '26' THEN TravelMileage ELSE 0 END ,2)) twentysix,
            SUM(ROUND(CASE day(date) WHEN '27' THEN TravelMileage ELSE 0 END ,2)) twentyseven,
            SUM(ROUND(CASE day(date) WHEN '28' THEN TravelMileage ELSE 0 END ,2)) twentyeight,
            SUM(ROUND(CASE day(date) WHEN '29' THEN TravelMileage ELSE 0 END ,2)) twentynine,
            SUM(ROUND(CASE day(date) WHEN '30' THEN TravelMileage ELSE 0 END ,2)) thirty,
            SUM(ROUND(CASE day(date) WHEN '31' THEN TravelMileage ELSE 0 END ,2)) thirtyone
        from
            statisticcensus
        where LEFT(date,7) = LEFT(#{date},7)
          and cid = #{deptId}
        <if test="vehNo != null and vehNo != ''">
          and cheliangpaizhao like '%${vehNo}%'
        </if>
        GROUP BY
            cheliangpaizhao,
            chepaiyanse,
            LEFT(#{date},7)
    </sql>

    <sql id="queryMonthMileageSql">

    </sql>

    <sql id="ordertMonthMileageSql">
        <!-- 默认排序规则 -->
        <if test="orderColumn == null or orderColumn == ''">
            order by TravelMileage desc
        </if>
        <if test="orderColumn != null and orderColumn != ''">
            order by ${orderColumn}
        </if>
        <if test="orderColumn != null and orderColumn != '' and order != 0">
            desc
        </if>
        <if test="orderColumn != null and orderColumn != '' and order == 0">
            asc
        </if>
    </sql>

    <select timeout="600" id="selectMonthMileageTJ" resultMap="QiYeMonthMileageTongJiResultMap"
            parameterType="org.springblade.anbiao.qiyeshouye.page.QiYeTTSTongJiPage">
        <if test="size == 0">
            select * from (
            <include refid="tabletMonthMileageSql"/>
            )b
            where 1=1
            <include refid="queryMonthMileageSql"/>
            <include refid="ordertMonthMileageSql"/>
            limit ${total}
        </if>
        <if test="current != 0">
            select * from (
            <include refid="tabletMonthMileageSql"/>
            )b
            where 1=1
            <include refid="queryMonthMileageSql"/>
            <include refid="ordertMonthMileageSql"/>
            limit ${offsetNo},${size}
        </if>
    </select>

    <select timeout="90" id="selectMonthMileageTotal"
            parameterType="org.springblade.anbiao.qiyeshouye.page.QiYeTTSTongJiPage"
            resultType="int">
        select COUNT(1) from (
        <include refid="tabletMonthMileageSql"/>
        )d where 1 = 1
        <include refid="queryMonthMileageSql"/>
    </select>

    <sql id="tableChuLiLvSql">
        select
            a.*,
            case
            when IFNULL(baojingclcishu,0) = 0 or IFNULL(baojingzongshu,0) = 0 then '0.00%'
            else concat(ROUND((baojingclcishu*1.0/baojingzongshu)*100,2),'%')
            end as baojingzongcllv,
            case
            when IFNULL(gpsbaojingclzongshu,0) = 0 or IFNULL(gpsbaojingzongshu,0) = 0 then '0.00%'
            else concat(ROUND((gpsbaojingclzongshu*1.0/gpsbaojingzongshu)*100,2),'%')
            end as gpsbaojingzongcllv,
            case
            when IFNULL(dmsbaojingclzongshu,0) = 0 or IFNULL(dmsbaojingzongshu,0) = 0 then '0.00%'
            else concat(ROUND((dmsbaojingclzongshu*1.0/dmsbaojingzongshu)*100,2),'%')
            end as dmsbaojingzongcllv,
            case
            when IFNULL(chaosucl,0) = 0 or IFNULL(gpschaosu,0) = 0 then '0.00%'
            else concat(ROUND((chaosucl*1.0/gpschaosu)*100,2),'%')
            end as gpschaosucllv,
            case
            when IFNULL(pilaocl,0) = 0 or IFNULL(gpspilao,0) = 0 then '0.00%'
            else concat(ROUND((pilaocl*1.0/gpspilao)*100,2),'%')
            end as gpspilaocllv,
            case
            when IFNULL(yejiancl,0) = 0 or IFNULL(gpsyejian,0) = 0 then '0.00%'
            else concat(ROUND((yejiancl*1.0/gpsyejian)*100,2),'%')
            end as gpsyejiancllv,
            case
            when IFNULL(yichangcl,0) = 0 or IFNULL(gpsyichang,0) = 0 then '0.00%'
            else concat(ROUND((yichangcl*1.0/gpsyichang)*100,2),'%')
            end as gpsyichangcllv,
            case
            when IFNULL(pilaoshipincl,0) = 0 or IFNULL(dmspilao,0) = 0 then '0.00%'
            else concat(ROUND((pilaoshipincl*1.0/dmspilao)*100,2),'%')
            end as dmspilaocllv,
            case
            when IFNULL(dadianhuacl,0) = 0 or IFNULL(dmsjiedadianhua,0) = 0 then '0.00%'
            else concat(ROUND((dadianhuacl*1.0/dmsjiedadianhua)*100,2),'%')
            end as dmsjiedadianhuacllv,
            case
            when IFNULL(chouyancl,0) = 0 or IFNULL(dmschouyan,0) = 0 then '0.00%'
            else concat(ROUND((chouyancl*1.0/dmschouyan)*100,2),'%')
            end as dmschouyancllv,
            case
            when IFNULL(fenshencl,0) = 0 or IFNULL(dmsfenshen,0) = 0 then '0.00%'
            else concat(ROUND((fenshencl*1.0/dmsfenshen)*100,2),'%')
            end as dmsfenshencllv
        from(
            select
                cid as deptId,
                company as deptName,
<!--                CONCAT(#{beginTime},'至',#{endTime}) as date,-->
                IFNULL(SUM(b.vehiclecount),0) as cheliangshu,
                ifnull(sum(b.baojingcishu),0) as baojingzongshu,
                ifnull(sum(b.baojingclcishu),0) as baojingclcishu,
                ifnull(sum(b.chaosu),0) as gpschaosu,
                ifnull(sum(b.pilao),0) as gpspilao,
                ifnull(sum(b.yejian),0) as gpsyejian,
                ifnull(sum(b.wushuju),0)+ifnull(sum(b.budingwei),0) as gpsyichang,
                ifnull(sum(b.chaosu),0)+ifnull(sum(b.pilao),0)+ifnull(sum(b.yejian),0)+ifnull(sum(b.wushuju),0)+ifnull(sum(b.budingwei),0) as gpsbaojingzongshu,
                ifnull(sum(b.pilaoshipin),0) as dmspilao,
                ifnull(sum(b.dadianhua),0) as dmsjiedadianhua,
                ifnull(sum(b.chouyan),0) as dmschouyan,
                ifnull(sum(b.fenshen),0) as dmsfenshen,
                ifnull(sum(b.pilaoshipin),0)+ifnull(sum(b.dadianhua),0)+ifnull(sum(b.chouyan),0)+ifnull(sum(b.fenshen),0)	dmsbaojingzongshu,
                ifnull(sum(b.chaosucl),0) as chaosucl,
                ifnull(sum(b.pilaocl),0) as pilaocl,
                ifnull(sum(b.yejiancl),0) as yejiancl,
                ifnull(sum(b.wushujucl),0)+ifnull(sum(b.budingweicl),0) as yichangcl,
                ifnull(sum(b.chaosucl),0)+ifnull(sum(b.pilaocl),0)+ifnull(sum(b.yejiancl),0)+ifnull(sum(b.wushujucl),0)+ifnull(sum(b.budingweicl),0) as gpsbaojingclzongshu,
                ifnull(sum(b.pilaoshipincl),0) as pilaoshipincl,
                ifnull(sum(b.dadianhuacl),0) as dadianhuacl,
                ifnull(sum(b.chouyancl),0) as chouyancl,
                ifnull(sum(b.fenshencl),0) as fenshencl,
                ifnull(sum(b.pilaoshipincl),0)+ifnull(sum(b.dadianhuacl),0)+ifnull(sum(b.chouyancl),0)+ifnull(sum(b.fenshencl),0) as dmsbaojingclzongshu
            from(
                select
                    a.cid,
                    company,
                    max(replace(ltrim(replace(vehiclecount,'0',' ')),' ','0')) vehiclecount,
                    sum(chaosu) as chaosu,
                    sum(pilao) as pilao,
                    sum(yejian) as yejian,
                    sum(wushuju) as wushuju,
                    sum(budingwei) as budingwei,
                    sum(pilaoshipin) as pilaoshipin,
                    sum(dadianhua) as dadianhua,
                    sum(chouyan) as chouyan,
                    sum(fenshen) as fenshen,
                    sum(baojingcishu) as baojingcishu,
                    sum(chaosucl) as chaosucl,
                    sum(pilaocl) as pilaocl,
                    sum(yejiancl) as yejiancl,
                    sum(wushujucl) as wushujucl,
                    sum(budingweicl) as budingweicl,
                    sum(pilaoshipincl) as pilaoshipincl,
                    sum(dadianhuacl) as dadianhuacl,
                    sum(chouyancl) as chouyancl,
                    sum(fenshencl) as fenshencl,
                    sum(baojingclcishu) as baojingclcishu
                from
                    baobiao_alarmdailyreport a
                where 1=1
                    and date &gt;= CONCAT(#{beginTime},' 00:00:00')
                    and date &lt; CONCAT(#{endTime},' 23:59:59')
                    and cid = #{deptId}
                GROUP BY
                    a.cid,
                    company
                )b
            GROUP BY
                cid,
                company
            )a
    </sql>

    <sql id="queryChuLiLvSql">

    </sql>

    <sql id="ordertChuLiLvSql">
        <!-- 默认排序规则 -->
        <if test="orderColumn == null or orderColumn == ''">
            order by baojingzongshu desc
        </if>
        <if test="orderColumn != null and orderColumn != ''">
            order by ${orderColumn}
        </if>
        <if test="orderColumn != null and orderColumn != '' and order != 0">
            desc
        </if>
        <if test="orderColumn != null and orderColumn != '' and order == 0">
            asc
        </if>
    </sql>

    <select timeout="600" id="selectChuLiLvTJ" resultMap="DeptBaoJingTongJiLvResultMap"
            parameterType="org.springblade.anbiao.qiyeshouye.page.QiYeTongJiPage">
        <if test="size == 0">
            select * from (
            <include refid="tableChuLiLvSql"/>
            )b
            where 1=1
            <include refid="queryChuLiLvSql"/>
            <include refid="ordertChuLiLvSql"/>
            limit ${total}
        </if>
        <if test="current != 0">
            select * from (
            <include refid="tableChuLiLvSql"/>
            )b
            where 1=1
            <include refid="queryChuLiLvSql"/>
            <include refid="ordertChuLiLvSql"/>
            limit ${offsetNo},${size}
        </if>
    </select>

    <select timeout="90" id="selectChuLiLvTotal"
            parameterType="org.springblade.anbiao.qiyeshouye.page.QiYeTongJiPage"
            resultType="int">
        select COUNT(1) from (
        <include refid="tableChuLiLvSql"/>
        )d where 1 = 1
        <include refid="queryChuLiLvSql"/>
    </select>

    <!--企业超速报警统计-->
    <sql id="tableDeptChaosuSql">
        select
            a.dept_id as deptId,
            a.dept_name as deptName,
            a.AlarmReportID,
            a.vehid,
            a.cheliangpaizhao,
            a.chepaiyanse,
            a.shiyongxingzhi,
            a.xinghao,
            date_format(date_sub(from_unixtime(b.KeepTime), INTERVAL 8 HOUR), '%H时%i分%s秒') as keepTime,
            b.alarmNum,
            a.Limited,
            b.MaxSpeed,
            CONCAT(a.ChaoSuBi,'%') as ChaoSuBi,
            a.Road_Name as roadName
        from(
            select
                AlarmReportID,
                ChaoSuBi,
                Limited,
                vehid,
                cheliangpaizhao,
                chepaiyanse,
                Road_Name,
                dept_id,
                dept_name,
                shiyongxingzhi,
                xinghao
            from
                baobiao_alarmsummary_cutofftime a, anbiao_vehicle b,blade_dept c
            where a.vehid = b.id
                and b.dept_id = c.id
                and LEFT(CutoffTime,10) &gt;= #{beginTime}
                and LEFT(CutoffTime,10) &lt;= #{endTime}
                and a.AnalyzeMode = 1
                and a.AlarmType = '超速报警'
                and a.Passed = 100
                and b.dept_id = #{deptId}
                and b.is_deleted = 0
            ) a
        inner join(
            select
                b.AlarmReportID,
                a.vehid,
                a.KeepTime,
                a.alarmNum,
                a.MaxSpeed
            from(
                select
                    vehid,
                    SUM(KeepTime) as KeepTime,
                    count(1) as alarmNum,
                    MAX(MaxSpeed) as MaxSpeed
                from
                    baobiao_alarmsummary_cutofftime a, anbiao_vehicle b
                where a.vehid = b.id
                    and LEFT(CutoffTime,10) &gt;= #{beginTime}
                    and LEFT(CutoffTime,10) &lt;= #{endTime}
                    and a.AnalyzeMode = 1
                    and a.AlarmType = '超速报警'
                    and a.Passed = 100
                    and b.dept_id = #{deptId}
                    and b.is_deleted = 0
                GROUP BY
                    vehid
                )a
            inner join(
                select
                    vehid,
                    MaxSpeed,
                    MAX(AlarmReportID) as AlarmReportID
                from
                    baobiao_alarmsummary_cutofftime a, anbiao_vehicle b
                where a.vehid = b.id
                      and LEFT(CutoffTime,10) &gt;= #{beginTime}
                      and LEFT(CutoffTime,10) &lt;= #{endTime}
                      and a.AnalyzeMode = 1
                      and a.AlarmType = '超速报警'
                      and a.Passed = 100
                      and b.dept_id = #{deptId}
                      and b.is_deleted = 0
                group by
                    vehid,
                    MaxSpeed
                ) b on a.vehid = b.vehid and a.MaxSpeed = b.MaxSpeed
            )b on a.AlarmReportID = b.AlarmReportID
        where 1=1
    </sql>

    <sql id="queryDeptChaosuSql">
        <if test="cheliangpaizhao != null and cheliangpaizhao != ''">
            and cheliangpaizhao like '%${cheliangpaizhao}%'
        </if>
    </sql>

    <sql id="ordertDeptChaosuSql">
        <!-- 默认排序规则 -->
        <if test="orderColumn == null or orderColumn == ''">
            order by alarmNum
        </if>
        <if test="orderColumn != null and orderColumn != ''">
            order by ${orderColumn}
        </if>
        <if test="orderColumn != null and orderColumn != '' and order != 0">
            desc
        </if>
        <if test="orderColumn != null and orderColumn != '' and order == 0">
            asc
        </if>
    </sql>

    <select timeout="600" id="selectDeptChaosuTJ" resultMap="DeptChaoSuBaoJingTongJiResultMap"
            parameterType="org.springblade.anbiao.qiyeshouye.page.QiYeAlarmTongJiPage">
        <if test="size == 0">
            select * from (
            <include refid="tableDeptChaosuSql"/>
            )b
            where 1=1
            <include refid="queryDeptChaosuSql"/>
            <include refid="ordertDeptChaosuSql"/>
            limit ${total}
        </if>
        <if test="current != 0">
            select * from (
            <include refid="tableDeptChaosuSql"/>
            )b
            where 1=1
            <include refid="queryDeptChaosuSql"/>
            <include refid="ordertDeptChaosuSql"/>
            limit ${offsetNo},${size}
        </if>
    </select>

    <select timeout="90" id="selectDeptChaosuTotal"
            parameterType="org.springblade.anbiao.qiyeshouye.page.QiYeAlarmTongJiPage"
            resultType="int">
        select COUNT(1) from (
        <include refid="tableDeptChaosuSql"/>
        )d where 1 = 1
        <include refid="queryDeptChaosuSql"/>
    </select>

    <!--持续不在线不定位车辆-->
    <sql id="tableDeptPersistentUnpositioningSql">
        select
            a.vehicleID,
            a.deptID,
            a.deptName,
            a.cheliangpaizhao,
            a.chepaiyanse,
            a.shiyongxingzhi,
            a.xinghao,
            a.lastLocateTime,
            a.lastLineTime,
            CONCAT(locate_DAY,locate_HOUR,locate_MINUTE,locate_SECOND) as lastLocatekeepTime,
            CONCAT(locate_DAY,locate_HOUR,locate_MINUTE,locate_SECOND) as lastLinekeepTime
        from(
            select
                b.id as vehicleID,
                b.dept_id as deptID,
                c.dept_name as deptName,
                b.cheliangpaizhao,
                b.chepaiyanse,
                b.shiyongxingzhi,
                b.xinghao,
                a.LastLocateTime,
                a.LastLocateTime as lastLineTime,
                CONCAT(convert(TRUNCATE(TIMESTAMPDIFF(SECOND,a.LastLocateTime,#{tongjiriqi})/(24*3600), 0), char), '天') locate_DAY,
                CONCAT(convert(TRUNCATE(TIMESTAMPDIFF(SECOND,a.LastLocateTime,#{tongjiriqi})%(24*3600)/3600, 0), char), '小时') locate_HOUR,
                CONCAT(convert(TRUNCATE(TIMESTAMPDIFF(SECOND,a.LastLocateTime,#{tongjiriqi})%3600/60, 0), char), '分') locate_MINUTE,
                CONCAT(convert(TRUNCATE((TIMESTAMPDIFF(SECOND,a.LastLocateTime,#{tongjiriqi}))%60, 0), char), '秒') locate_SECOND
            from
                tpvehdata a
                inner join anbiao_vehicle b on a.Vehid = b.id
                inner join blade_dept c on b.dept_id = c.id
            where b.dept_id = #{deptId}
              and b.is_deleted = 0
              and a.locate = 1
            )a
        where a.locate_DAY >= #{day}
    </sql>

    <sql id="queryDeptPersistentUnpositioningSql">
        <if test="cheliangpaizhao != null and cheliangpaizhao != ''">
            and cheliangpaizhao like '%${cheliangpaizhao}%'
        </if>
    </sql>

    <sql id="ordertDeptPersistentUnpositioningSql">
        <!-- 默认排序规则 -->
        <if test="orderColumn == null or orderColumn == ''">
            order by cheliangpaizhao
        </if>
        <if test="orderColumn != null and orderColumn != ''">
            order by ${orderColumn}
        </if>
        <if test="orderColumn != null and orderColumn != '' and order != 0">
            desc
        </if>
        <if test="orderColumn != null and orderColumn != '' and order == 0">
            asc
        </if>
    </sql>

    <select timeout="600" id="selectDeptPersistentUnpositioningTJ" resultMap="DeptPersistentUnpositioningTongJiResultMap"
            parameterType="org.springblade.anbiao.qiyeshouye.page.PersistentUnpositioningTongJiPage">
        <if test="size == 0">
            select * from (
            <include refid="tableDeptPersistentUnpositioningSql"/>
            )b
            where 1=1
            <include refid="queryDeptPersistentUnpositioningSql"/>
            <include refid="ordertDeptPersistentUnpositioningSql"/>
            limit ${total}
        </if>
        <if test="current != 0">
            select * from (
            <include refid="tableDeptPersistentUnpositioningSql"/>
            )b
            where 1=1
            <include refid="queryDeptPersistentUnpositioningSql"/>
            <include refid="ordertDeptPersistentUnpositioningSql"/>
            limit ${offsetNo},${size}
        </if>
    </select>

    <select timeout="90" id="selectDeptPersistentUnpositioningTotal"
            parameterType="org.springblade.anbiao.qiyeshouye.page.PersistentUnpositioningTongJiPage"
            resultType="int">
        select COUNT(1) from (
        <include refid="tableDeptPersistentUnpositioningSql"/>
        )d where 1 = 1
        <include refid="queryDeptPersistentUnpositioningSql"/>
    </select>

    <!--疲劳驾驶报警统计-->
    <sql id="tableDeptPiLaoSql">
        select
            a.dept_id as deptId,
            a.dept_name as deptName,
            a.AlarmReportID,
            a.beginTime,
            a.endTime,
            a.vehid,
            a.cheliangpaizhao,
            a.chepaiyanse,
            a.shiyongxingzhi,
            a.xinghao,
            date_format(date_sub(from_unixtime(b.KeepTime), INTERVAL 8 HOUR), '%H时%i分%s秒') as keepTime,
            b.alarmNum,
            date_format(date_sub(from_unixtime(b.MaxKeepTime), INTERVAL 8 HOUR), '%H时%i分%s秒') as MaxKeepTime,
            a.Road_Name as roadName
        from(
            select
                AlarmReportID,
                beginTime,
                endTime,
                vehid,
                cheliangpaizhao,
                chepaiyanse,
                Road_Name,
                dept_id,
                dept_name,
                shiyongxingzhi,
                xinghao
            from
                baobiao_alarmsummary_cutofftime a, anbiao_vehicle b,blade_dept c
            where a.vehid = b.id
                and b.dept_id = c.id
                and LEFT(CutoffTime,10) &gt;= #{beginTime}
                and LEFT(CutoffTime,10) &lt;= #{endTime}
                and AnalyzeMode = 1
                and Passed = 100
                and AlarmType = '疲劳驾驶报警'
                and b.dept_id = #{deptId}
                and b.is_deleted = 0
            ) a
        inner join(
            select
                b.AlarmReportID,
                a.vehid,
                a.KeepTime,
                a.alarmNum,
                a.MaxKeepTime
            from(
                select
                    vehid,
                    SUM(KeepTime) as KeepTime,
                    count(1) as alarmNum,
                    MAX(KeepTime) as MaxKeepTime
                from
                    baobiao_alarmsummary_cutofftime a, anbiao_vehicle b
                where a.vehid = b.id
                    and LEFT(CutoffTime,10) &gt;= #{beginTime}
                    and LEFT(CutoffTime,10) &lt;= #{endTime}
                    and AnalyzeMode = 1
                    and Passed = 100
                    and AlarmType = '疲劳驾驶报警'
                    and b.dept_id = #{deptId}
                    and b.is_deleted = 0
                GROUP BY
                    vehid
                )a
            inner join(
                select
                vehid,
                KeepTime,
                MAX(AlarmReportID) as AlarmReportID
            from
                baobiao_alarmsummary_cutofftime a, anbiao_vehicle b
            where a.vehid = b.id
                and LEFT(CutoffTime,10) &gt;= #{beginTime}
                and LEFT(CutoffTime,10) &lt;= #{endTime}
                and AnalyzeMode = 1
                and Passed = 100
                and AlarmType = '疲劳驾驶报警'
                and b.dept_id = #{deptId}
                and b.is_deleted = 0
            group by
                vehid,
                KeepTime
            ) b on a.vehid = b.vehid and a.MaxKeepTime = b.KeepTime
        )b on a.AlarmReportID = b.AlarmReportID
        where 1=1
    </sql>

    <sql id="queryDeptPiLaoSql">
        <if test="cheliangpaizhao != null and cheliangpaizhao != ''">
            and cheliangpaizhao like '%${cheliangpaizhao}%'
        </if>
    </sql>

    <sql id="ordertDeptPiLaoSql">
        <!-- 默认排序规则 -->
        <if test="orderColumn == null or orderColumn == ''">
            order by alarmNum
        </if>
        <if test="orderColumn != null and orderColumn != ''">
            order by ${orderColumn}
        </if>
        <if test="orderColumn != null and orderColumn != '' and order != 0">
            desc
        </if>
        <if test="orderColumn != null and orderColumn != '' and order == 0">
            asc
        </if>
    </sql>

    <select timeout="600" id="selectDeptPiLaoTJ" resultMap="DeptPiLaoBaoJingTongJiResultMap"
            parameterType="org.springblade.anbiao.qiyeshouye.page.QiYeAlarmTongJiPage">
        <if test="size == 0">
            select * from (
            <include refid="tableDeptPiLaoSql"/>
            )b
            where 1=1
            <include refid="queryDeptPiLaoSql"/>
            <include refid="ordertDeptPiLaoSql"/>
            limit ${total}
        </if>
        <if test="current != 0">
            select * from (
            <include refid="tableDeptPiLaoSql"/>
            )b
            where 1=1
            <include refid="queryDeptPiLaoSql"/>
            <include refid="ordertDeptPiLaoSql"/>
            limit ${offsetNo},${size}
        </if>
    </select>

    <select timeout="90" id="selectDeptPiLaoTotal"
            parameterType="org.springblade.anbiao.qiyeshouye.page.QiYeAlarmTongJiPage"
            resultType="int">
        select COUNT(1) from (
        <include refid="tableDeptPiLaoSql"/>
        )d where 1 = 1
        <include refid="queryDeptPiLaoSql"/>
    </select>

    <!--驾驶打卡统计-->
    <sql id="tableDaKaInfoSql">
        select
            a.*,
            b.shoujihaoma,
            c.id as deptId,
            c.dept_name as deptName
        from
            anbiao_jiashiyuan_daka_info a
            left join anbiao_jiashiyuan b on a.jiashiyuanid = b.id
            left join blade_dept c on c.id = b.dept_id
        where b.isdelete = 0
          and c.is_deleted = 0
          and c.id = #{deptId}
          and a.dakashijian >= CONCAT(#{beginTime},' 00:00:00')
          and a.dakashijian &lt;= CONCAT(#{endTime},' 23:59:59')
    </sql>

    <sql id="queryDaKaInfoSql">
        <if test="cheliangpaizhao != null and cheliangpaizhao != ''">
            and cheliangpaizhao like '%${cheliangpaizhao}%'
        </if>
        <if test="jiashiyuan != null and jiashiyuan != ''">
            and jiashiyuan like '%${jiashiyuan}%'
        </if>
    </sql>

    <sql id="orderDaKaInfoSql">
        <!-- 默认排序规则 -->
        <if test="orderColumn == null or orderColumn == ''">
            order by dakashijian
        </if>
        <if test="orderColumn != null and orderColumn != ''">
            order by ${orderColumn}
        </if>
        <if test="orderColumn != null and orderColumn != '' and order != 0">
            desc
        </if>
        <if test="orderColumn != null and orderColumn != '' and order == 0">
            asc
        </if>
    </sql>

    <select timeout="600" id="selectDaKaInfoTJ" resultMap="JiashiyuanDakaInfoBaseResultMap"
            parameterType="org.springblade.anbiao.qiyeshouye.page.QiYeAlarmTongJiPage">
        <if test="size == 0">
            select * from (
            <include refid="tableDaKaInfoSql"/>
            )b
            where 1=1
            <include refid="queryDaKaInfoSql"/>
            <include refid="orderDaKaInfoSql"/>
            limit ${total}
        </if>
        <if test="current != 0">
            select * from (
            <include refid="tableDaKaInfoSql"/>
            )b
            where 1=1
            <include refid="queryDaKaInfoSql"/>
            <include refid="orderDaKaInfoSql"/>
            limit ${offsetNo},${size}
        </if>
    </select>

    <select timeout="90" id="selectDaKaInfoTotal"
            parameterType="org.springblade.anbiao.qiyeshouye.page.QiYeAlarmTongJiPage"
            resultType="int">
        select COUNT(1) from (
        <include refid="tableDaKaInfoSql"/>
        )d where 1 = 1
        <include refid="queryDaKaInfoSql"/>
    </select>

    <!-- 阜阳车辆报警排名 -->
    <sql id="tableFYVehAlarmSql">
        select
            dept.dept_name as company,
            dept.id as cid,
            v.id as vehid,
            v.cheliangpaizhao,
            v.chepaiyanse,
            v.shiyongxingzhi,
            CONCAT(#{beginTime},'至',#{endTime}) as date,
            ifnull(chaosu,0)+ifnull(pilao,0)+ifnull(yejian,0)+ifnull(wushuju,0)+ifnull(budingwei,0)+IFNULL(t2.wbpilao,0) as baojingcishu,
            IFNULL(t1.chaosu,0) as chaosu,
            IFNULL(t1.pilao,0) as pilao,
            IFNULL(t1.yejian,0) as yejian,
            IFNULL(t1.wushuju,0) as wushuju,
            IFNULL(t1.budingwei,0) as budingwei,
            IFNULL(t2.wbpilao,0) as wbpilao,
            IFNULL(budingwei+wushuju,0) as yichang,
            0 as duche
        from(
        SELECT
        DISTINCT
        xiaji.id,
        xiaji.parent_id,
        xiaji.dept_name,
        xiaji.is_deleted
        FROM
        blade_dept shangji,
        blade_dept xiaji
        WHERE xiaji.tree_code LIKE CONCAT(shangji.tree_code,'%')
        AND xiaji.is_deleted = 0 AND xiaji.extend_type='机构'
        AND shangji.id = #{deptId}
        )dept
        LEFT JOIN anbiao_vehicle v on dept.id = v.dept_id
        LEFT JOIN(
        select
        DISTINCT
        v.dept_id,
        v.id,
        v.cheliangpaizhao,
        v.chepaiyanse,
        v.shiyongxingzhi,
        AlarmType,
        COUNT(case when a.alarmType='超速报警' then 1 else null end) as chaosu,
        COUNT(case when a.alarmType='疲劳驾驶报警' then 1 else null end) as pilao,
        COUNT(case when a.alarmType='夜间行驶报警' then 1 else null end) as yejian,
        COUNT(case when a.alarmType='停驶违规报警' then 1 else null end) as tingshi,
        COUNT(case when a.alarmType='无数据报警' then 1 else null end) as wushuju,
        COUNT(case when a.alarmType='不定位报警' then 1 else null end) as budingwei
        from
        baobiao_alarmsummary_cutofftime a
        left join anbiao_vehicle v on a.VehId = v.id
        where 1=1
        <if test=" beginTime != null and beginTime != '' ">
            and cutoffTime &gt;= CONCAT( '${beginTime}', ' 00:00:00')
            and cutoffTime &lt;= CONCAT( '${endTime}', ' 23:59:59')
        </if>
        and Passed = 100
        and AnalyzeMode = 1
        GROUP BY
        v.dept_id,
        v.id,
        v.cheliangpaizhao,
        v.chepaiyanse,
        v.shiyongxingzhi,
        AlarmType
        )t1 on t1.id = v.id
        LEFT JOIN(
        select
        DISTINCT
        v.dept_id,
        v.id,
        v.cheliangpaizhao,
        v.chepaiyanse,
        v.shiyongxingzhi,
        AlarmType,
        COUNT(case when a.alarmType='疲劳驾驶报警' then 1 else null end) as wbpilao
        from
        baobiao_alarmsummary_cutofftime a
        left join anbiao_vehicle v on a.VehId = v.id
        where 1=1
        <if test=" beginTime != null and beginTime != '' ">
            and cutoffTime &gt;= CONCAT( '${beginTime}', ' 00:00:00')
            and cutoffTime &lt;= CONCAT( '${endTime}', ' 23:59:59')
        </if>
        and Passed not in(100,99)
        and AnalyzeMode = 1
        and alarmType='疲劳驾驶报警'
        GROUP BY
        v.dept_id,
        v.id,
        v.cheliangpaizhao,
        v.chepaiyanse,
        v.shiyongxingzhi,
        AlarmType
        )t2 on t2.id = v.id
    </sql>

    <sql id="queryFYVehAlarmSql">

        <if test="cheliangpaizhao != null and cheliangpaizhao != '' ">
            and cheliangpaizhao like concat('%', #{cheliangpaizhao} ,'%')
        </if>
        and baojingcishu > 0
    </sql>

    <sql id="orderFYVehAlarmSql">
        <!-- 默认排序规则 -->
        <if test="orderColumn == null or orderColumn == ''">
            order by baojingcishu desc
        </if>
        <if test="orderColumn != null and orderColumn != ''">
            order by ${orderColumn}
        </if>
        <if test="orderColumn != null and orderColumn != '' and order != 0">
            desc
        </if>
    </sql>

    <select timeout="600" id="selectFYVehAlarmPage" resultMap="ResultMap"
            parameterType="org.springblade.anbiao.qiyeshouye.page.QiYeTongJiPage">
        <if test="size == 0">
            select * from (
            <include refid="tableFYVehAlarmSql"/>
            )b
            where 1=1
            <include refid="queryFYVehAlarmSql"/>
            <include refid="orderFYVehAlarmSql"/>
            limit ${total}
        </if>
        <if test="current != 0">
            select * from (
            <include refid="tableFYVehAlarmSql"/>
            )b
            where 1=1
            <include refid="queryFYVehAlarmSql"/>
            <include refid="orderFYVehAlarmSql"/>
            limit ${offsetNo},${size}
        </if>
    </select>

    <select timeout="90" id="selectFYVehAlarmTotal"
            parameterType="org.springblade.anbiao.qiyeshouye.page.QiYeTongJiPage"
            resultType="int">
        select COUNT(1) from (
        <include refid="tableFYVehAlarmSql"/>
        )d where 1 = 1
        <include refid="orderFYVehAlarmSql"/>
    </select>


</mapper>
